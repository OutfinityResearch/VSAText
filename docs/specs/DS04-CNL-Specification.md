# DS04 — CNL Specification

## What is CNL?

CNL (Controlled Natural Language) is a human-readable, machine-parseable language for narrative specifications. It uses Subject-Verb-Object syntax that mirrors natural English while being precise enough for automated parsing.

CNL is auto-generated by the visual editor. Authors don't write it directly—they compose visually, and the system generates CNL.

```
Visual Editor → CNL → Parser → AST → Metrics
```

## Dual-Layer CNL (SVO + LLM Annotations)

CNL serves two consumers:

- **Metrics / verification**: uses pure SVO statements (WHAT must be true).
- **LLM prose generation**: uses an annotation layer (HOW to write) that is ignored by metrics.

Annotations use `#` and attach to the previous SVO statement (or become global if they appear before any statement):

```cnl
Anna has trait brave
#hint: Show bravery through action, not declarations.
#avoid: Heroic monologues.

#style: Understated, concrete sensory detail.
Story has genre horror
```

## Core Syntax

### Identifiers

Simple identifiers start with a letter: `Anna`, `Village`, `Chapter1`

Quoted identifiers handle multi-word names: `"The Dark Forest"`, `"inner strength"`

### Statement Types

| Pattern | Meaning | Example |
|---------|---------|---------|
| `X is Y` | Type declaration | `Anna is protagonist` |
| `X has Y Z` | Property | `Anna has trait courage` |
| `X relates to Y as Z` | Relationship | `Anna relates to Marcus as sibling` |
| `X requires "Y"` | Must have | `Story requires "happy ending"` |
| `X forbids "Y"` | Must not have | `Story forbids "violence"` |
| `X must Y Z` | Obligation | `Chapter_1 must introduce Anna` |
| `X owns Y` | Ownership | `Anna owns SilverKey` |
| `X has tone Y` | Tone | `Story has tone hopeful` |
| `X has max Y Z` | Maximum | `Story has max characters 10` |
| `X references @Y` | Cross-reference | `Chapter2 references @Chapter1` |

### Groups

Groups create hierarchical structure (chapters containing scenes containing beats):

```
Chapter1 group begin
  Chapter1 has title "The Beginning"
  
  Scene1 group begin
    Anna discovers artifact
  Scene1 group end
Chapter1 group end
```

### Comments

```
// Single line comment
/* Multi-line comment */
```

### LLM Annotations (not comments)

Annotations are not parsed as statements and do not affect metrics, but they are stored in the AST and can be used for prompt-building:

```cnl
#example: "Her hands trembled, but she stepped forward anyway."

Sc7 has purpose revelation
#example: begin
  Elena's hand froze on the door handle.
  "I knew your mother," Mira said.
#example: end
```

## Entity Types

| Type | Examples |
|------|----------|
| Characters | `protagonist`, `antagonist`, `mentor`, `ally` |
| Locations | `location`, `place`, `setting` |
| Moods | `mood` (emotional register for scenes) |
| Props | `artifact`, `object`, `item` |
| Themes | `theme`, `motif` |

Additional common spec types (recommended stable IDs like `R1`, `W1`, `P1`):
- `world_rule`, `wisdom`, `pattern`, `template`

## Constraints

Constraints control what must or must not appear in generated content:

```
Story requires "happy ending"     // Must include
Story forbids "explicit violence" // Must exclude
Story has tone hopeful            // Emotional direction
Story has max characters 10       // Numerical limit
Chapter_1 must introduce Anna     // Specific obligation
```

## Pattern System

Patterns are reusable templates with variable slots:

```
P1 is pattern
P1 has label "Hero's Call"
P1 has variable $hero as character
P1 has variable $location as location

P1 has template begin
  $hero is at $location
  $hero discovers "call to adventure"
P1 has template end
```

Instantiate by binding variables to entities:

```
Sc1 uses pattern P1
Sc1 binds $hero to Anna
Sc1 binds $location to Village
```

## Example

```
// Characters
Anna is protagonist
Anna has trait courage
Anna relates to Marcus as sibling

// Locations  
Village is location
Village has atmosphere peaceful

// Blueprint (beats)
Blueprint uses arc heros_journey
Beat call_to_adventure mapped to Ch1.Sc2
call_to_adventure has tension 2
call_to_adventure has mood mysterious

// Constraints
Story requires "happy ending"
Story forbids "violence"
Story has tone hopeful

// World rules (stable IDs)
World is setting
R1 is world_rule
R1 has text "Magic requires sacrifice"
R1 has category magic
R1 applies to World
World includes rule R1

// Wisdom (stable IDs)
W1 is wisdom
W1 has label "True strength is showing mercy"
W1 has category moral
W1 has insight "Mercy is strength when it is costly"
Story includes wisdom W1

// Structure
Book group begin
  Chapter1 group begin
    Anna is at Village
    Anna discovers storm
  Chapter1 group end
Book group end
```

## Parsing Output

The parser produces an AST with:
- `entities` - all declared entities with properties
- `groups` - hierarchical structure
- `constraints` - requires/forbids/must/tone/max/min
- `relationships` - entity connections
- `ownership` - who owns what
- `references` - cross-references between groups

Metrics are calculated by interpreting this AST against generated content.
