<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCRIPTA - Visual Story Composer</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #1a1a2e;
      --bg-main: #242442;
      --bg-surface: #2d2d52;
      --bg-elevated: #363663;
      --bg-hover: #404075;
      --accent-gold: #ffd166;
      --accent-rose: #ef476f;
      --accent-emerald: #06d6a0;
      --accent-sky: #118ab2;
      --accent-violet: #9d4edd;
      --accent-amber: #fb8500;
      --text-primary: #f8f9fa;
      --text-secondary: #c9d1d9;
      --text-muted: #8b949e;
      --text-faded: #6e7681;
      --entity-character: #06d6a0;
      --entity-location: #118ab2;
      --entity-mood: #9d4edd;
      --entity-block: #fb8500;
      --entity-object: #ffd166;
      --entity-theme: #ef476f;
      --entity-rule: #4cc9f0;
      --entity-arc: #7b2cbf;
      --font-title: 'Cinzel', serif;
      --font-body: 'Crimson Text', serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-body); background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; overflow: hidden; }
    body::before { content: ''; position: fixed; inset: 0; background: radial-gradient(ellipse at 20% 80%, rgba(157, 78, 221, 0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 20%, rgba(255, 209, 102, 0.06) 0%, transparent 50%); pointer-events: none; }
    .app { display: grid; grid-template-columns: 280px 1fr 320px; grid-template-rows: 52px 1fr 36px; height: 100vh; }
    header { grid-column: 1 / -1; background: linear-gradient(180deg, var(--bg-surface) 0%, var(--bg-main) 100%); border-bottom: 1px solid var(--bg-elevated); padding: 0 1rem; display: flex; align-items: center; justify-content: space-between; }
    .logo h1 { font-family: var(--font-title); font-size: 1.2rem; background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-amber) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 0.1em; }
    .header-center { display: flex; align-items: center; gap: 0.75rem; }
    .project-name { font-family: var(--font-title); font-size: 0.95rem; background: transparent; border: none; border-bottom: 1px solid transparent; color: var(--text-primary); padding: 0.2rem 0.4rem; min-width: 180px; text-align: center; }
    .project-name:focus { outline: none; border-color: var(--accent-gold); }
    .arc-select { font-family: var(--font-mono); font-size: 0.65rem; background: var(--bg-surface); border: 1px solid var(--bg-elevated); color: var(--text-secondary); padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; }
    .arc-select:focus { outline: none; border-color: var(--accent-violet); }
    .header-actions { display: flex; gap: 0.4rem; }
    .btn { font-family: var(--font-title); font-size: 0.6rem; letter-spacing: 0.06em; text-transform: uppercase; padding: 0.4rem 0.8rem; border: 1px solid var(--bg-hover); border-radius: 4px; background: var(--bg-surface); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
    .btn:hover { border-color: var(--accent-violet); color: var(--text-primary); background: var(--bg-elevated); }
    .btn.primary { background: var(--accent-violet); border-color: var(--accent-violet); color: white; }
    .btn.success { background: var(--accent-emerald); border-color: var(--accent-emerald); color: var(--bg-deep); }
    .btn.accent { background: var(--accent-gold); border-color: var(--accent-gold); color: var(--bg-deep); }
    .btn.danger { background: var(--accent-rose); border-color: var(--accent-rose); color: white; }
    .btn.random { background: linear-gradient(135deg, var(--accent-amber), var(--accent-rose)); border: none; color: white; }
    .btn.small { font-size: 0.55rem; padding: 0.3rem 0.5rem; }
    
    .tree-panel { background: var(--bg-main); border-right: 1px solid var(--bg-elevated); display: flex; flex-direction: column; overflow: hidden; }
    .panel-header { padding: 0.6rem 0.8rem; border-bottom: 1px solid var(--bg-elevated); display: flex; justify-content: space-between; align-items: center; background: var(--bg-surface); }
    .panel-title { font-family: var(--font-title); font-size: 0.65rem; letter-spacing: 0.1em; color: var(--text-muted); text-transform: uppercase; }
    .tree-container { flex: 1; overflow-y: auto; padding: 0.4rem; }
    .tree-node-content { display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.5rem; border-radius: 4px; cursor: pointer; transition: all 0.15s; font-size: 0.85rem; }
    .tree-node-content:hover { background: var(--bg-surface); }
    .tree-node-content.selected { background: var(--bg-elevated); border-left: 2px solid var(--accent-gold); }
    .tree-icon { font-size: 0.9rem; width: 18px; text-align: center; }
    .tree-label { flex: 1; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tree-type { font-size: 0.6rem; color: var(--text-faded); font-family: var(--font-mono); }
    .tree-children { margin-left: 1rem; border-left: 1px solid var(--bg-elevated); padding-left: 0.2rem; }
    .tree-add { width: 20px; height: 20px; border-radius: 50%; border: 1px dashed var(--text-faded); background: transparent; color: var(--text-faded); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .tree-add:hover { border-color: var(--accent-emerald); color: var(--accent-emerald); border-style: solid; }
    
    .center-panel { background: var(--bg-main); display: flex; flex-direction: column; overflow: hidden; }
    .tabs { display: flex; background: var(--bg-surface); border-bottom: 1px solid var(--bg-elevated); overflow-x: auto; flex-shrink: 0; }
    .tab { padding: 0.55rem 0.7rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-family: var(--font-title); font-size: 0.55rem; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; white-space: nowrap; }
    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
    .tab-content { flex: 1; overflow: auto; padding: 0.8rem; }
    .view { display: none; }
    .view.active { display: block; }
    
    .cnl-output { background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 4px; padding: 0.8rem; font-family: var(--font-mono); font-size: 0.75rem; line-height: 1.5; color: var(--text-secondary); min-height: 300px; white-space: pre-wrap; overflow: auto; }
    
    .entity-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.8rem; }
    .entity-card { background: var(--bg-surface); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .entity-card:hover { border-color: var(--bg-hover); transform: translateY(-1px); }
    .entity-card.character { border-left: 3px solid var(--entity-character); }
    .entity-card.location { border-left: 3px solid var(--entity-location); }
    .entity-card.mood { border-left: 3px solid var(--entity-mood); }
    .entity-card.block { border-left: 3px solid var(--entity-block); }
    .entity-card.object { border-left: 3px solid var(--entity-object); }
    .entity-card.rule { border-left: 3px solid var(--entity-rule); }
    .entity-card.arc { border-left: 3px solid var(--entity-arc); }
    .entity-name { font-family: var(--font-title); font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.2rem; }
    .entity-type { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.4rem; }
    .entity-desc { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 0.4rem; }
    .entity-tags { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.4rem; }
    .entity-tag { font-size: 0.6rem; padding: 0.15rem 0.4rem; background: var(--bg-elevated); border-radius: 3px; color: var(--text-secondary); }
    .add-entity-card { background: transparent; border: 2px dashed var(--bg-elevated); border-radius: 6px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 100px; }
    .add-entity-card:hover { border-color: var(--accent-emerald); }
    .add-entity-card .icon { font-size: 1.5rem; color: var(--text-faded); margin-bottom: 0.3rem; }
    .add-entity-card:hover .icon { color: var(--accent-emerald); }
    .add-entity-card span { color: var(--text-muted); font-size: 0.75rem; }
    
    /* Relationships View - IMPROVED */
    .relationships-view { display: flex; flex-direction: column; gap: 1rem; }
    .graph-container { width: 100%; height: 450px; background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 6px; position: relative; overflow: hidden; }
    .graph-svg { width: 100%; height: 100%; }
    .graph-node { cursor: pointer; }
    .graph-node circle { transition: all 0.2s; }
    .graph-node:hover circle { stroke-width: 4; stroke: var(--accent-gold); }
    .graph-node text { font-family: var(--font-title); fill: var(--text-primary); pointer-events: none; }
    .graph-node .node-name { font-size: 11px; font-weight: 600; }
    .graph-node .node-archetype { font-size: 9px; fill: rgba(255,255,255,0.7); }
    .graph-edge { fill: none; stroke-width: 2; }
    .graph-edge-label { font-size: 10px; fill: var(--text-secondary); font-family: var(--font-body); }
    .graph-controls { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.3rem; }
    .graph-legend { display: flex; flex-wrap: wrap; gap: 0.8rem; padding: 0.6rem; background: var(--bg-surface); border-radius: 4px; }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.7rem; color: var(--text-secondary); }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .relationships-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.6rem; }
    .relationship-card { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem 0.8rem; background: var(--bg-surface); border-radius: 4px; border-left: 3px solid var(--text-muted); }
    .relationship-card:hover { background: var(--bg-elevated); }
    .rel-from, .rel-to { font-weight: 600; color: var(--text-primary); font-size: 0.85rem; }
    .rel-type { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; padding: 0.2rem 0.4rem; background: var(--bg-deep); border-radius: 3px; }
    .rel-arrow { color: var(--text-faded); }
    .rel-delete { margin-left: auto; background: transparent; border: none; color: var(--text-faded); cursor: pointer; font-size: 1rem; padding: 0.2rem; }
    .rel-delete:hover { color: var(--accent-rose); }
    
    /* Emotional Arc View */
    .emotional-arc-view { display: flex; flex-direction: column; gap: 1rem; }
    .arc-timeline { background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 1rem; min-height: 200px; }
    .arc-timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .arc-timeline-title { font-family: var(--font-title); font-size: 0.8rem; color: var(--text-primary); }
    .arc-beats { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
    .arc-beat { flex: 0 0 auto; min-width: 120px; padding: 0.6rem; background: var(--bg-surface); border-radius: 4px; border-left: 3px solid var(--entity-arc); }
    .arc-beat-position { font-size: 0.6rem; color: var(--text-faded); font-family: var(--font-mono); }
    .arc-beat-label { font-size: 0.8rem; color: var(--text-primary); font-weight: 600; margin: 0.2rem 0; }
    .arc-beat-desc { font-size: 0.7rem; color: var(--text-muted); }
    .arc-beat-mood { margin-top: 0.4rem; }
    .arc-beat-mood select { width: 100%; font-size: 0.7rem; padding: 0.3rem; background: var(--bg-deep); border: 1px solid var(--bg-elevated); color: var(--text-secondary); border-radius: 3px; }
    
    /* World Rules View */
    .rules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem; }
    .rule-card { background: var(--bg-surface); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 0.8rem; border-left: 3px solid var(--entity-rule); }
    .rule-card:hover { border-color: var(--bg-hover); }
    .rule-category { font-size: 0.6rem; color: var(--entity-rule); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
    .rule-name { font-family: var(--font-title); font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.3rem; }
    .rule-desc { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; }
    .rule-scope { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.4rem; font-style: italic; }
    
    /* Blocks View - IMPROVED */
    .blocks-view { display: flex; flex-direction: column; gap: 1rem; }
    .blocks-filter { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .blocks-filter .btn { font-size: 0.55rem; padding: 0.25rem 0.5rem; }
    .blocks-filter .btn.active { background: var(--accent-amber); border-color: var(--accent-amber); color: var(--bg-deep); }
    .blocks-section { margin-bottom: 1rem; }
    .blocks-section-title { font-family: var(--font-title); font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--bg-elevated); }
    .block-card { background: var(--bg-surface); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 0.7rem; border-left: 3px solid var(--entity-block); cursor: pointer; transition: all 0.2s; }
    .block-card:hover { border-color: var(--accent-amber); transform: translateY(-1px); }
    .block-card.used { opacity: 0.6; border-left-color: var(--accent-emerald); }
    .block-card.used::after { content: ' (used)'; font-size: 0.6rem; color: var(--accent-emerald); }
    .block-name { font-family: var(--font-title); font-size: 0.85rem; color: var(--text-primary); }
    .block-desc { font-size: 0.7rem; color: var(--text-muted); margin: 0.2rem 0; }
    .block-meta { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.4rem; }
    .block-scope { font-size: 0.55rem; padding: 0.15rem 0.35rem; background: var(--bg-deep); border-radius: 3px; color: var(--text-faded); }
    
    .metrics-panel { background: var(--bg-main); border-left: 1px solid var(--bg-elevated); display: flex; flex-direction: column; overflow: hidden; }
    .metrics-content { flex: 1; overflow-y: auto; padding: 0.6rem; }
    .metrics-section { margin-bottom: 1rem; }
    .metrics-section-title { font-family: var(--font-title); font-size: 0.6rem; letter-spacing: 0.08em; color: var(--text-faded); text-transform: uppercase; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--bg-elevated); }
    .metric-card { background: var(--bg-surface); border: 1px solid var(--bg-elevated); border-radius: 4px; padding: 0.5rem; margin-bottom: 0.4rem; }
    .metric-header { display: flex; justify-content: space-between; align-items: baseline; }
    .metric-name { font-family: var(--font-title); font-size: 0.55rem; letter-spacing: 0.04em; color: var(--text-muted); text-transform: uppercase; }
    .metric-value { font-family: var(--font-mono); font-size: 0.95rem; font-weight: 600; }
    .metric-value.good { color: var(--accent-emerald); }
    .metric-value.warn { color: var(--accent-amber); }
    .metric-value.bad { color: var(--accent-rose); }
    .metric-value.neutral { color: var(--text-secondary); }
    .metric-bar { height: 4px; background: var(--bg-elevated); border-radius: 2px; margin-top: 0.3rem; }
    .metric-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
    .metric-detail { font-size: 0.65rem; color: var(--text-faded); margin-top: 0.25rem; }
    .metric-status { font-size: 0.6rem; display: flex; align-items: center; gap: 0.2rem; margin-top: 0.2rem; }
    .metric-status.pass { color: var(--accent-emerald); }
    .metric-status.fail { color: var(--accent-rose); }
    .metric-status.na { color: var(--text-faded); }
    .metric-breakdown { font-size: 0.6rem; color: var(--text-faded); margin-top: 0.2rem; font-family: var(--font-mono); }
    
    footer { grid-column: 1 / -1; background: var(--bg-surface); border-top: 1px solid var(--bg-elevated); padding: 0 0.8rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); }
    .footer-stats { display: flex; gap: 1rem; }
    .stat-value { color: var(--text-secondary); font-family: var(--font-mono); }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(26, 26, 46, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-surface); border: 1px solid var(--bg-hover); border-radius: 8px; width: 90%; max-width: 700px; max-height: 85vh; overflow: hidden; }
    .modal.wide { max-width: 900px; }
    .modal-header { padding: 0.8rem 1rem; border-bottom: 1px solid var(--bg-elevated); display: flex; justify-content: space-between; align-items: center; background: var(--bg-elevated); }
    .modal-title { font-family: var(--font-title); font-size: 0.95rem; color: var(--text-primary); }
    .modal-close { width: 24px; height: 24px; background: transparent; border: 1px solid var(--bg-hover); border-radius: 50%; color: var(--text-muted); font-size: 12px; cursor: pointer; }
    .modal-close:hover { border-color: var(--accent-rose); color: var(--accent-rose); }
    .modal-body { padding: 1rem; max-height: 60vh; overflow-y: auto; }
    .modal-footer { padding: 0.8rem 1rem; border-top: 1px solid var(--bg-elevated); display: flex; justify-content: flex-end; gap: 0.4rem; }
    
    .form-group { margin-bottom: 0.8rem; }
    .form-label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.5rem 0.6rem; background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 4px; color: var(--text-primary); font-family: var(--font-body); font-size: 0.85rem; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-violet); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .form-hint { font-size: 0.65rem; color: var(--text-faded); margin-top: 0.2rem; font-style: italic; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
    
    .chip-select { display: flex; flex-wrap: wrap; gap: 0.4rem; padding: 0.5rem; background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 4px; max-height: 150px; overflow-y: auto; }
    .chip { font-size: 0.7rem; padding: 0.25rem 0.5rem; background: var(--bg-elevated); border: 1px solid var(--bg-hover); border-radius: 4px; cursor: pointer; transition: all 0.15s; color: var(--text-secondary); }
    .chip:hover { border-color: var(--accent-violet); }
    .chip.selected { background: var(--accent-violet); border-color: var(--accent-violet); color: white; }
    .chip-category { width: 100%; font-size: 0.6rem; color: var(--text-faded); text-transform: uppercase; margin-top: 0.4rem; margin-bottom: 0.2rem; letter-spacing: 0.05em; }
    .chip-category:first-child { margin-top: 0; }
    
    /* Mood Builder */
    .mood-builder { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .mood-palette { background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 0.8rem; }
    .mood-palette-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
    .emotion-grid { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .emotion-chip { display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem; border: 1px solid var(--bg-hover); transition: all 0.15s; }
    .emotion-chip:hover { border-color: var(--accent-violet); }
    .emotion-chip.active { border-width: 2px; }
    .emotion-chip .intensity { display: flex; gap: 2px; }
    .emotion-chip .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--bg-hover); }
    .emotion-chip .dot.filled { background: currentColor; }
    .mood-preview { background: var(--bg-deep); border: 1px solid var(--bg-elevated); border-radius: 6px; padding: 0.8rem; }
    .mood-bar { height: 24px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden; display: flex; margin: 0.5rem 0; }
    .mood-bar-segment { height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .mood-presets { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem; }
    .mood-preset { font-size: 0.6rem; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; border: 1px solid var(--bg-hover); background: var(--bg-surface); color: var(--text-secondary); }
    .mood-preset:hover { border-color: var(--accent-violet); }
    
    .context-menu { position: fixed; background: var(--bg-elevated); border: 1px solid var(--bg-hover); border-radius: 6px; padding: 0.3rem 0; min-width: 150px; z-index: 1001; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: none; }
    .context-menu.open { display: block; }
    .context-menu-item { padding: 0.4rem 0.8rem; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 0.4rem; }
    .context-menu-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .context-menu-divider { height: 1px; background: var(--bg-hover); margin: 0.2rem 0; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }
    
    .tree-node[draggable="true"] { cursor: grab; }
    .tree-node[draggable="true"]:active { cursor: grabbing; }
    .tree-node.dragging { opacity: 0.5; }
    .tree-node.drag-over > .tree-node-content { background: var(--accent-violet); color: white; }
    
    .empty-state { text-align: center; padding: 2rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .empty-state-text { font-size: 0.85rem; }
    .empty-state-hint { font-size: 0.75rem; color: var(--text-faded); margin-top: 0.3rem; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><h1>SCRIPTA</h1></div>
      <div class="header-center">
        <input type="text" class="project-name" id="project-name" value="Untitled Story">
        <select class="arc-select" id="arc-select" title="Narrative Arc">
          <option value="heros_journey">Hero's Journey</option>
          <option value="three_act">Three Act</option>
          <option value="save_the_cat">Save the Cat</option>
          <option value="story_circle">Story Circle</option>
          <option value="kishotenketsu">Kishotenketsu</option>
          <option value="five_act">Five Act</option>
          <option value="seven_point">Seven Point</option>
        </select>
      </div>
      <div class="header-actions">
        <button class="btn random" id="btn-random" title="Generate complete random story">Random</button>
        <button class="btn" id="btn-new">New</button>
        <button class="btn success" id="btn-export">Export CNL</button>
        <button class="btn primary" id="btn-evaluate">Evaluate</button>
      </div>
    </header>

    <aside class="tree-panel">
      <div class="panel-header">
        <span class="panel-title">Structure</span>
        <button class="tree-add" id="btn-add-root" title="Add Book">+</button>
      </div>
      <div class="tree-container" id="tree-container"></div>
    </aside>

    <main class="center-panel">
      <div class="tabs">
        <button class="tab active" data-view="cnl">CNL</button>
        <button class="tab" data-view="characters">Characters</button>
        <button class="tab" data-view="relationships">Relations</button>
        <button class="tab" data-view="locations">Locations</button>
        <button class="tab" data-view="objects">Objects</button>
        <button class="tab" data-view="moods">Moods</button>
        <button class="tab" data-view="emotionalarc">Arc</button>
        <button class="tab" data-view="blocks">Blocks</button>
        <button class="tab" data-view="worldrules">World</button>
        <button class="tab" data-view="themes">Themes</button>
      </div>
      <div class="tab-content">
        <div class="view active" id="view-cnl">
          <div class="cnl-output" id="cnl-output">// CNL auto-generated from visual structure</div>
        </div>
        <div class="view" id="view-characters"><div class="entity-grid" id="characters-grid"></div></div>
        <div class="view" id="view-relationships">
          <div class="relationships-view" id="relationships-view"></div>
        </div>
        <div class="view" id="view-locations"><div class="entity-grid" id="locations-grid"></div></div>
        <div class="view" id="view-objects"><div class="entity-grid" id="objects-grid"></div></div>
        <div class="view" id="view-moods"><div class="entity-grid" id="moods-grid"></div></div>
        <div class="view" id="view-emotionalarc"><div class="emotional-arc-view" id="emotionalarc-view"></div></div>
        <div class="view" id="view-blocks"><div class="blocks-view" id="blocks-view"></div></div>
        <div class="view" id="view-worldrules"><div class="rules-grid" id="worldrules-grid"></div></div>
        <div class="view" id="view-themes"><div class="entity-grid" id="themes-grid"></div></div>
      </div>
    </main>

    <aside class="metrics-panel">
      <div class="panel-header"><span class="panel-title">Metrics</span></div>
      <div class="metrics-content" id="metrics-content"></div>
    </aside>

    <footer>
      <div class="footer-stats">
        <span>Chars: <span class="stat-value" id="stat-chars">0</span></span>
        <span>Locs: <span class="stat-value" id="stat-locs">0</span></span>
        <span>Scenes: <span class="stat-value" id="stat-scenes">0</span></span>
        <span>Rules: <span class="stat-value" id="stat-rules">0</span></span>
      </div>
      <span>SCRIPTA v3.1</span>
    </footer>
  </div>

  <div class="context-menu" id="context-menu"></div>
  
  <div class="modal-overlay" id="entity-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Add Entity</h2>
        <button class="modal-close" onclick="closeModal('entity-modal')">x</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('entity-modal')">Cancel</button>
        <button class="btn primary" id="btn-modal-save">Save</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="select-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="select-modal-title">Select</h2>
        <button class="modal-close" onclick="closeModal('select-modal')">x</button>
      </div>
      <div class="modal-body" id="select-modal-body"></div>
    </div>
  </div>

  <script type="module">
import VOCAB from './vocabularies.mjs';

const state = {
  project: {
    id: null,
    name: 'Untitled Story',
    selectedArc: 'heros_journey',
    libraries: { 
      characters: [], 
      locations: [], 
      objects: [], 
      moods: [],        // Scene-level moods
      emotionalArc: [], // Global emotional arc points
      themes: [],
      relationships: [],
      worldRules: []    // Special rules and physics
    },
    structure: null
  },
  selectedNode: null,
  editingEntity: null,
  blocksFilter: 'all'
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const genId = () => 'id_' + Math.random().toString(36).substr(2, 8);
const pick = arr => arr[Math.floor(Math.random() * arr.length)];
const pickN = (arr, n) => [...arr].sort(() => 0.5 - Math.random()).slice(0, Math.min(n, arr.length));

window.openModal = id => document.getElementById(id).classList.add('open');
window.closeModal = id => document.getElementById(id).classList.remove('open');

// ==================== TREE ====================
function renderTree() {
  const c = $('#tree-container');
  if (!state.project.structure) {
    c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìñ</div><div class="empty-state-text">No structure yet</div><div class="empty-state-hint">Click + to add a Book</div></div>';
    return;
  }
  c.innerHTML = renderNode(state.project.structure);
  updateStats();
  generateCNL();
}

function renderNode(n, d=0) {
  const icons = {book:'üìñ',chapter:'üìë',scene:'üé¨','character-ref':'üë§','location-ref':'üìç','object-ref':'üóùÔ∏è','mood-ref':'üé≠','block-ref':'‚ú®','action':'‚ö°'};
  const sel = state.selectedNode === n.id ? 'selected' : '';
  let label = n.title || n.name || n.type;
  
  if (n.type === 'action' && n.actionData) {
    const act = VOCAB.ACTIONS[n.actionData.action];
    label = `${n.actionData.subject} ${act?.label || n.actionData.action} ${n.actionData.target || ''}`.trim();
  }
  
  const canDrag = !['book'].includes(n.type);
  let ch = '';
  if (n.children?.length) ch = `<div class="tree-children">${n.children.map(x=>renderNode(x,d+1)).join('')}</div>`;
  return `<div class="tree-node" data-id="${n.id}" data-type="${n.type}" draggable="${canDrag}" 
    ondragstart="handleDragStart(event,'${n.id}')" ondragend="handleDragEnd(event)"
    ondragover="handleDragOver(event,'${n.id}')" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event,'${n.id}')">
    <div class="tree-node-content ${sel}" onclick="selectNode('${n.id}')" oncontextmenu="showCtx(event,'${n.id}')">
      <span class="tree-icon">${icons[n.type]||'‚Ä¢'}</span>
      <span class="tree-label">${label}</span>
      <span class="tree-type">${n.type}</span>
    </div>${ch}</div>`;
}

window.selectNode = id => { state.selectedNode = id; renderTree(); };

// Drag handlers
let draggedNodeId = null;
window.handleDragStart = (e, id) => { draggedNodeId = id; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; };
window.handleDragEnd = (e) => { e.target.classList.remove('dragging'); $$('.tree-node.drag-over').forEach(el => el.classList.remove('drag-over')); draggedNodeId = null; };
window.handleDragOver = (e, targetId) => { e.preventDefault(); if (draggedNodeId && draggedNodeId !== targetId) e.target.closest('.tree-node')?.classList.add('drag-over'); };
window.handleDragLeave = (e) => { e.target.closest('.tree-node')?.classList.remove('drag-over'); };
window.handleDrop = (e, targetId) => {
  e.preventDefault();
  e.target.closest('.tree-node')?.classList.remove('drag-over');
  if (!draggedNodeId || draggedNodeId === targetId) return;
  const draggedNode = findNode(draggedNodeId);
  const targetNode = findNode(targetId);
  const draggedParent = findParent(draggedNodeId);
  if (!draggedNode || !targetNode || !draggedParent) return;
  if (isDescendant(targetNode, draggedNodeId)) return;
  draggedParent.children = draggedParent.children.filter(c => c.id !== draggedNodeId);
  if (!targetNode.children) targetNode.children = [];
  targetNode.children.push(draggedNode);
  renderTree();
};

function findNode(id, n=state.project.structure) {
  if (!n) return null;
  if (n.id === id) return n;
  for (const c of n.children||[]) { const f = findNode(id, c); if (f) return f; }
  return null;
}
function findParent(id, n=state.project.structure, p=null) {
  if (!n) return null;
  if (n.id === id) return p;
  for (const c of n.children||[]) { const f = findParent(id, c, n); if (f) return f; }
  return null;
}
function isDescendant(node, ancestorId) {
  if (node.id === ancestorId) return true;
  for (const c of node.children || []) { if (isDescendant(c, ancestorId)) return true; }
  return false;
}

// ==================== CONTEXT MENU ====================
window.showCtx = (e, id) => {
  e.preventDefault();
  const n = findNode(id);
  const m = $('#context-menu');
  let items = [];
  if (n.type === 'book' || n.type === 'chapter') items.push({a:'add-chapter',l:'+ Chapter'},{a:'add-scene',l:'+ Scene'});
  if (n.type === 'scene') items.push({a:'add-char',l:'+ Character'},{a:'add-loc',l:'+ Location'},{a:'add-obj',l:'+ Object'},{a:'add-mood',l:'+ Mood'},{a:'add-block',l:'+ Narrative Block'},{a:'add-action',l:'+ Action'});
  items.push({a:'div'},{a:'edit',l:'Edit'},{a:'delete',l:'Delete'});
  m.innerHTML = items.map(i => i.a==='div' ? '<div class="context-menu-divider"></div>' : `<div class="context-menu-item" data-action="${i.a}" data-id="${id}">${i.l}</div>`).join('');
  m.style.left = e.pageX + 'px';
  m.style.top = e.pageY + 'px';
  m.classList.add('open');
};
document.addEventListener('click', () => $('#context-menu').classList.remove('open'));
document.addEventListener('click', e => {
  const item = e.target.closest('.context-menu-item');
  if (!item) return;
  const {action, id} = item.dataset;
  const n = findNode(id);
  if (!n) return;
  if (action === 'add-chapter') addChild(n, {type:'chapter',name:`Ch${(n.children?.length||0)+1}`,title:'',children:[]});
  if (action === 'add-scene') addChild(n, {type:'scene',name:`Sc${(n.children?.length||0)+1}`,title:'',children:[]});
  if (action === 'add-char') showSelectModal('characters', n);
  if (action === 'add-loc') showSelectModal('locations', n);
  if (action === 'add-obj') showSelectModal('objects', n);
  if (action === 'add-mood') showSelectModal('moods', n);
  if (action === 'add-block') showBlockModal(n);
  if (action === 'add-action') showActionModal(n);
  if (action === 'edit') editNodeProps(n);
  if (action === 'delete') { if (state.project.structure?.id === id) state.project.structure = null; else { const p = findParent(id); if (p) p.children = p.children.filter(c=>c.id!==id); } state.selectedNode = null; renderTree(); }
});

function addChild(p, t) { if (!p.children) p.children = []; p.children.push({...t, id:genId()}); renderTree(); }

function editNodeProps(n) {
  $('#modal-title').textContent = 'Edit ' + n.type;
  $('#modal-body').innerHTML = `<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="edit-name" value="${n.name||''}"></div>
    <div class="form-group"><label class="form-label">Title</label><input class="form-input" id="edit-title" value="${n.title||''}"></div>`;
  $('#btn-modal-save').onclick = () => { n.name = $('#edit-name').value||n.name; n.title = $('#edit-title').value||''; closeModal('entity-modal'); renderTree(); };
  openModal('entity-modal');
}

function showSelectModal(type, parent) {
  const list = state.project.libraries[type];
  $('#select-modal-title').textContent = 'Select ' + type.slice(0,-1);
  if (!list.length) {
    $('#select-modal-body').innerHTML = `<div class="empty-state"><div class="empty-state-text">No ${type} yet</div><div class="empty-state-hint">Create some in the ${type} tab first</div></div>`;
  } else {
    $('#select-modal-body').innerHTML = list.map(e => `<div class="entity-card ${type.slice(0,-1)}" onclick="addRef('${type}','${e.id}','${parent.id}')" style="margin-bottom:0.5rem;">
      <div class="entity-name">${e.name}</div><div class="entity-type">${e.archetype||e.geography||e.objectType||''}</div></div>`).join('');
  }
  openModal('select-modal');
}
window.addRef = (type, eid, pid) => {
  const e = state.project.libraries[type].find(x=>x.id===eid);
  const p = findNode(pid);
  if (!e || !p) return;
  const refType = type === 'objects' ? 'object-ref' : type === 'moods' ? 'mood-ref' : type.slice(0,-1)+'-ref';
  addChild(p, {type:refType, name:e.name, refId:eid});
  closeModal('select-modal');
};

function showBlockModal(parent) {
  const blocks = Object.entries(VOCAB.NARRATIVE_BLOCKS);
  const usedBlocks = getUsedBlocks();
  $('#select-modal-title').textContent = 'Select Narrative Block';
  const phases = ['opening','transition','confrontation','resolution','micro'];
  let html = '';
  phases.forEach(phase => {
    const phaseBlocks = blocks.filter(([k,v]) => v.phase === phase);
    if (phaseBlocks.length) {
      html += `<div style="margin-bottom:0.8rem;"><div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.5rem;border-bottom:1px solid var(--bg-elevated);padding-bottom:0.3rem;">${phase}</div>`;
      html += `<div class="entity-grid">`;
      html += phaseBlocks.map(([k,v]) => {
        const isUsed = usedBlocks.has(k);
        return `<div class="block-card ${isUsed?'used':''}" onclick="applyBlock('${k}','${parent.id}')">
          <div class="block-name">${v.label}</div>
          <div class="block-desc">${v.desc}</div>
          <div class="block-meta">
            <span class="block-scope">${v.scope}</span>
            ${v.suggestedMoods.slice(0,2).map(m=>`<span class="entity-tag">${m}</span>`).join('')}
          </div>
        </div>`;
      }).join('');
      html += `</div></div>`;
    }
  });
  $('#select-modal-body').innerHTML = html;
  openModal('select-modal');
}
window.applyBlock = (key, pid) => {
  const p = findNode(pid);
  const block = VOCAB.NARRATIVE_BLOCKS[key];
  if (!p || !block) return;
  addChild(p, {type:'block-ref', name:block.label, blockKey:key});
  closeModal('select-modal');
};

function getUsedBlocks() {
  const used = new Set();
  function traverse(n) {
    if (!n) return;
    if (n.type === 'block-ref' && n.blockKey) used.add(n.blockKey);
    (n.children||[]).forEach(traverse);
  }
  traverse(state.project.structure);
  return used;
}

function showActionModal(parent) {
  const actions = Object.entries(VOCAB.ACTIONS);
  const chars = state.project.libraries.characters;
  if (chars.length === 0) {
    $('#select-modal-title').textContent = 'Add Action';
    $('#select-modal-body').innerHTML = `<div class="empty-state"><div class="empty-state-text">No characters yet</div><div class="empty-state-hint">Create characters first to add actions</div></div>`;
    openModal('select-modal');
    return;
  }
  $('#select-modal-title').textContent = 'Add Action';
  let html = `<div class="form-group"><label class="form-label">Subject</label>
    <select class="form-select" id="action-subject">${chars.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">Action</label>
    <select class="form-select" id="action-type">${actions.map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">Target (optional)</label>
    <select class="form-select" id="action-target"><option value="">--</option>${chars.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')}
    ${state.project.libraries.locations.map(l=>`<option value="${l.name}">${l.name} (location)</option>`).join('')}
    ${state.project.libraries.objects.map(o=>`<option value="${o.name}">${o.name} (object)</option>`).join('')}</select></div>
    <button class="btn primary" onclick="saveAction('${parent.id}')">Add Action</button>`;
  $('#select-modal-body').innerHTML = html;
  openModal('select-modal');
}
window.saveAction = (pid) => {
  const p = findNode(pid);
  if (!p) return;
  const subject = $('#action-subject').value;
  const action = $('#action-type').value;
  const target = $('#action-target').value;
  addChild(p, {type:'action', name:`${subject} ${action}`, actionData:{subject, action, target}});
  closeModal('select-modal');
};

// ==================== ENTITY EDITORS ====================
function renderEntityGrid(type) {
  const c = $(`#${type}-grid`);
  if (!c) return;
  const list = state.project.libraries[type];
  
  if (list.length === 0) {
    c.innerHTML = `<div class="add-entity-card" onclick="addEntity('${type}')"><div class="icon">+</div><span>Add ${type.slice(0,-1)}</span></div>`;
    return;
  }
  
  let cards = list.map(e => {
    let tags = '';
    if (e.traits?.length) tags = `<div class="entity-tags">${e.traits.slice(0,4).map(t=>`<span class="entity-tag">${t}</span>`).join('')}</div>`;
    if (e.emotions && typeof e.emotions === 'object') {
      const emotionList = Object.entries(e.emotions).slice(0,3).map(([k,v])=>`<span class="entity-tag">${k}:${v}</span>`);
      tags = `<div class="entity-tags">${emotionList.join('')}</div>`;
    }
    let sub = e.archetype || e.geography || e.objectType || e.themeKey || '';
    const cardType = type === 'objects' ? 'object' : type.slice(0,-1);
    return `<div class="entity-card ${cardType}" onclick="editEntity('${type}','${e.id}')">
      <div class="entity-name">${e.name}</div><div class="entity-type">${sub}</div>${tags}</div>`;
  }).join('');
  cards += `<div class="add-entity-card" onclick="addEntity('${type}')"><div class="icon">+</div><span>Add ${type.slice(0,-1)}</span></div>`;
  c.innerHTML = cards;
}

window.addEntity = type => { state.editingEntity = null; showEntityForm(type, null); };
window.editEntity = (type, id) => { state.editingEntity = id; showEntityForm(type, state.project.libraries[type].find(e=>e.id===id)); };
window.deleteEntity = (type, id) => {
  const entity = state.project.libraries[type].find(e => e.id === id);
  if (!entity || !confirm(`Delete "${entity.name}"?`)) return;
  state.project.libraries[type] = state.project.libraries[type].filter(e => e.id !== id);
  removeEntityRefs(state.project.structure, id);
  closeModal('entity-modal');
  renderEntityGrid(type);
  renderTree();
};
function removeEntityRefs(node, refId) {
  if (!node) return;
  if (node.children) {
    node.children = node.children.filter(c => c.refId !== refId);
    node.children.forEach(c => removeEntityRefs(c, refId));
  }
}

function showEntityForm(type, e) {
  const isEdit = !!e;
  $('#modal-title').textContent = (isEdit ? 'Edit ' : 'Add ') + type.slice(0,-1);
  let html = '';
  
  if (isEdit) {
    html += `<div style="display:flex;justify-content:flex-end;margin-bottom:0.8rem;">
      <button class="btn danger" onclick="deleteEntity('${type}','${e.id}')">Delete</button></div>`;
  }
  
  if (type === 'characters') {
    html += `<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="e-name" value="${e?.name||pick(VOCAB.NAMES.characters)}"></div>
      <div class="form-group"><label class="form-label">Archetype</label>
      <select class="form-select" id="e-archetype">${Object.entries(VOCAB.CHARACTER_ARCHETYPES).map(([k,v])=>`<option value="${k}" ${e?.archetype===k?'selected':''}>${v.label} - ${v.desc}</option>`).join('')}</select></div>
      <div class="form-group"><label class="form-label">Traits</label>
      <div class="chip-select" id="e-traits">${renderTraitChips(e?.traits||[])}</div></div>`;
  }
  
  if (type === 'locations') {
    html += `<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="e-name" value="${e?.name||pick(VOCAB.NAMES.locations)}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Geography</label>
        <select class="form-select" id="e-geography">${Object.entries(VOCAB.LOCATION_GEOGRAPHY).map(([k,v])=>`<option value="${k}" ${e?.geography===k?'selected':''}>${v.label}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Time Period</label>
        <select class="form-select" id="e-time">${Object.entries(VOCAB.LOCATION_TIME).map(([k,v])=>`<option value="${k}" ${e?.time===k?'selected':''}>${v.label}</option>`).join('')}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Characteristics</label>
      <div class="chip-select" id="e-chars">${renderLocationChips(e?.characteristics||[])}</div></div>`;
  }
  
  if (type === 'objects') {
    html += `<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="e-name" value="${e?.name||pick(VOCAB.NAMES.objects)}"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Type</label>
        <select class="form-select" id="e-objectType">${Object.entries(VOCAB.OBJECT_TYPES).map(([k,v])=>`<option value="${k}" ${e?.objectType===k?'selected':''}>${v.icon} ${v.label}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Significance</label>
        <select class="form-select" id="e-significance">${Object.entries(VOCAB.OBJECT_SIGNIFICANCE).map(([k,v])=>`<option value="${k}" ${e?.significance===k?'selected':''}>${v.label}</option>`).join('')}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Owner</label>
      <select class="form-select" id="e-owner"><option value="">-- None --</option>
      ${state.project.libraries.characters.map(c=>`<option value="${c.id}" ${e?.ownerId===c.id?'selected':''}>${c.name}</option>`).join('')}</select></div>`;
  }
  
  if (type === 'moods') {
    html += renderMoodBuilder(e);
  }
  
  if (type === 'themes') {
    html += `<div class="form-group"><label class="form-label">Select Theme</label>
      <div id="e-themes" class="entity-grid">${Object.entries(VOCAB.THEMES).map(([k,v])=>`<div class="entity-card ${e?.themeKey===k?'selected':''}" onclick="selectTheme('${k}')" data-key="${k}" style="margin-bottom:0.4rem;${e?.themeKey===k?'border-color:var(--accent-amber);background:rgba(251,133,0,0.1);':''}">
        <div class="entity-name">${v.label}</div><div class="entity-type">${v.desc}</div>
        <div class="entity-tags">${v.suggestedBlocks.slice(0,3).map(b=>`<span class="entity-tag">${b}</span>`).join('')}</div></div>`).join('')}</div></div>`;
  }
  
  $('#modal-body').innerHTML = html;
  $('#btn-modal-save').onclick = () => saveEntity(type);
  openModal('entity-modal');
}

function renderMoodBuilder(e) {
  const emotions = e?.emotions || {};
  return `<div class="mood-builder">
    <div class="mood-palette">
      <div class="mood-palette-title">Click emotions to add (click again to increase intensity 1-3)</div>
      ${['positive','negative','mixed'].map(valence => `
        <div style="margin-top:0.5rem;font-size:0.6rem;color:var(--text-faded);text-transform:uppercase;">${valence}</div>
        <div class="emotion-grid">
          ${Object.entries(VOCAB.EMOTIONS).filter(([k,v])=>v.valence===valence).map(([k,v])=>{
            const intensity = emotions[k] || 0;
            return `<div class="emotion-chip ${intensity>0?'active':''}" onclick="toggleEmotion('${k}')" data-emotion="${k}" data-intensity="${intensity}" style="background:${intensity>0?v.color:'var(--bg-elevated)'}">
              <span>${v.label}</span>
              <div class="intensity">${[1,2,3].map(i=>`<div class="dot ${intensity>=i?'filled':''}"></div>`).join('')}</div>
            </div>`;
          }).join('')}
        </div>
      `).join('')}
    </div>
    <div class="mood-preview">
      <div class="mood-palette-title">Your Mood</div>
      <input class="form-input" id="e-mood-name" value="${e?.name||'Custom Mood'}" placeholder="Mood name">
      <div class="mood-bar" id="mood-bar"></div>
      <div class="mood-palette-title" style="margin-top:0.5rem;">Quick Presets</div>
      <div class="mood-presets">
        ${Object.entries(VOCAB.MOOD_PRESETS).map(([k,v])=>`<div class="mood-preset" onclick="applyMoodPreset('${k}')" style="border-left:3px solid ${v.color}">${v.label}</div>`).join('')}
      </div>
    </div>
  </div>`;
}

window.toggleEmotion = (emotionKey) => {
  const chip = $(`.emotion-chip[data-emotion="${emotionKey}"]`);
  let intensity = parseInt(chip.dataset.intensity || '0');
  intensity = intensity >= 3 ? 0 : intensity + 1;
  chip.dataset.intensity = intensity;
  chip.classList.toggle('active', intensity > 0);
  chip.style.background = intensity > 0 ? VOCAB.EMOTIONS[emotionKey].color : 'var(--bg-elevated)';
  // Update dots
  chip.querySelectorAll('.dot').forEach((dot, i) => {
    dot.classList.toggle('filled', intensity >= i + 1);
  });
  updateMoodPreview();
};

window.applyMoodPreset = (presetKey) => {
  const preset = VOCAB.MOOD_PRESETS[presetKey];
  if (!preset) return;
  $$('.emotion-chip').forEach(c => { 
    c.dataset.intensity = '0'; 
    c.classList.remove('active'); 
    c.style.background = 'var(--bg-elevated)';
    c.querySelectorAll('.dot').forEach(d => d.classList.remove('filled'));
  });
  Object.entries(preset.emotions).forEach(([k,v]) => {
    const chip = $(`.emotion-chip[data-emotion="${k}"]`);
    if (chip) {
      chip.dataset.intensity = v;
      chip.classList.add('active');
      chip.style.background = VOCAB.EMOTIONS[k].color;
      chip.querySelectorAll('.dot').forEach((dot, i) => {
        dot.classList.toggle('filled', v >= i + 1);
      });
    }
  });
  $('#e-mood-name').value = preset.label;
  updateMoodPreview();
};

function updateMoodPreview() {
  const emotions = {};
  $$('.emotion-chip').forEach(c => {
    const intensity = parseInt(c.dataset.intensity || '0');
    if (intensity > 0) emotions[c.dataset.emotion] = intensity;
  });
  const bar = $('#mood-bar');
  if (!bar) return;
  const total = Object.values(emotions).reduce((a,b)=>a+b, 0) || 1;
  bar.innerHTML = Object.entries(emotions).map(([k,v]) => {
    const pct = (v/total)*100;
    return `<div class="mood-bar-segment" style="width:${pct}%;background:${VOCAB.EMOTIONS[k].color}">${k}</div>`;
  }).join('');
}

function renderTraitChips(selected) {
  const cats = {};
  Object.entries(VOCAB.CHARACTER_TRAITS).forEach(([k,v]) => {
    if (!cats[v.category]) cats[v.category] = [];
    cats[v.category].push({k, ...v, sel: selected.includes(k)});
  });
  return Object.entries(cats).map(([cat, traits]) => 
    `<div class="chip-category">${cat}</div>` + traits.map(t => `<div class="chip ${t.sel?'selected':''}" data-key="${t.k}" onclick="toggleChip(this)" title="${t.desc}">${t.label}</div>`).join('')
  ).join('');
}

function renderLocationChips(selected) {
  const cats = {};
  Object.entries(VOCAB.LOCATION_CHARACTERISTICS).forEach(([k,v]) => {
    if (!cats[v.category]) cats[v.category] = [];
    cats[v.category].push({k, ...v, sel: selected.includes(k)});
  });
  return Object.entries(cats).map(([cat, chars]) => 
    `<div class="chip-category">${cat}</div>` + chars.map(c => `<div class="chip ${c.sel?'selected':''}" data-key="${c.k}" onclick="toggleChip(this)" title="${c.desc}">${c.label}</div>`).join('')
  ).join('');
}

window.toggleChip = el => el.classList.toggle('selected');
window.selectTheme = k => { $$('#e-themes .entity-card').forEach(c => { c.classList.remove('selected'); c.style.borderColor = ''; c.style.background = ''; }); const sel = $(`#e-themes .entity-card[data-key="${k}"]`); if(sel) { sel.classList.add('selected'); sel.style.borderColor = 'var(--accent-amber)'; sel.style.background = 'rgba(251,133,0,0.1)'; }};

function saveEntity(type) {
  const e = state.editingEntity ? state.project.libraries[type].find(x=>x.id===state.editingEntity) : {id:genId()};
  
  if (type === 'characters') {
    e.name = $('#e-name').value || 'Character';
    e.archetype = $('#e-archetype').value;
    e.traits = [...$$('#e-traits .chip.selected')].map(c=>c.dataset.key);
  }
  if (type === 'locations') {
    e.name = $('#e-name').value || 'Location';
    e.geography = $('#e-geography').value;
    e.time = $('#e-time').value;
    e.characteristics = [...$$('#e-chars .chip.selected')].map(c=>c.dataset.key);
  }
  if (type === 'objects') {
    e.name = $('#e-name').value || 'Object';
    e.objectType = $('#e-objectType').value;
    e.significance = $('#e-significance').value;
    e.ownerId = $('#e-owner').value || null;
  }
  if (type === 'moods') {
    e.name = $('#e-mood-name').value || 'Mood';
    e.emotions = {};
    $$('.emotion-chip').forEach(c => {
      const intensity = parseInt(c.dataset.intensity || '0');
      if (intensity > 0) e.emotions[c.dataset.emotion] = intensity;
    });
  }
  if (type === 'themes') {
    const sel = $('#e-themes .entity-card.selected');
    if (!sel) { alert('Select a theme'); return; }
    const k = sel.dataset.key;
    const t = VOCAB.THEMES[k];
    e.name = t.label;
    e.themeKey = k;
  }
  
  if (!state.editingEntity) state.project.libraries[type].push(e);
  closeModal('entity-modal');
  renderEntityGrid(type);
  if (type === 'characters') renderRelationshipsView();
  generateCNL();
}

// ==================== RELATIONSHIPS VIEW (IMPROVED) ====================
function renderRelationshipsView() {
  const container = $('#relationships-view');
  const chars = state.project.libraries.characters;
  const rels = state.project.libraries.relationships;
  
  if (chars.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîó</div><div class="empty-state-text">No characters yet</div><div class="empty-state-hint">Add characters first to create relationships</div></div>`;
    return;
  }
  
  // Build SVG graph
  const width = container.clientWidth || 700;
  const height = 450;
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) * 0.35;
  
  // Position nodes in a circle
  const nodes = chars.map((c, i) => {
    const angle = (i / chars.length) * 2 * Math.PI - Math.PI/2;
    const archetypeColors = {hero:'#ffd166',mentor:'#9d4edd',shadow:'#e63946',ally:'#06d6a0',trickster:'#fb8500',herald:'#4cc9f0',shapeshifter:'#ff6b6b',threshold_guardian:'#a8dadc',mother:'#f4a261',father:'#2a9d8f',innocent:'#e9c46a',outcast:'#6c757d'};
    return {
      ...c,
      x: centerX + radius * Math.cos(angle),
      y: centerY + radius * Math.sin(angle),
      color: archetypeColors[c.archetype] || '#118ab2'
    };
  });
  
  // Draw edges
  let edgesHtml = '';
  rels.forEach(r => {
    const from = nodes.find(n => n.id === r.fromId);
    const to = nodes.find(n => n.id === r.toId);
    if (!from || !to) return;
    const relType = VOCAB.RELATIONSHIP_TYPES[r.type];
    const color = relType?.color || '#8b949e';
    const midX = (from.x + to.x) / 2;
    const midY = (from.y + to.y) / 2 - 8;
    edgesHtml += `<line class="graph-edge" x1="${from.x}" y1="${from.y}" x2="${to.x}" y2="${to.y}" stroke="${color}" stroke-opacity="0.7" />`;
    edgesHtml += `<text class="graph-edge-label" x="${midX}" y="${midY}" text-anchor="middle">${relType?.label || r.type}</text>`;
  });
  
  // Draw nodes
  let nodesHtml = '';
  nodes.forEach(n => {
    nodesHtml += `<g class="graph-node" transform="translate(${n.x},${n.y})" onclick="editEntity('characters','${n.id}')">
      <circle r="30" fill="${n.color}" stroke="var(--bg-deep)" stroke-width="3" />
      <text class="node-name" y="0" text-anchor="middle">${n.name.length > 10 ? n.name.slice(0,9)+'‚Ä¶' : n.name}</text>
      <text class="node-archetype" y="12" text-anchor="middle">${n.archetype||''}</text>
    </g>`;
  });
  
  // Legend
  const legendItems = [
    {color:'#ffd166', label:'Hero'}, {color:'#9d4edd', label:'Mentor'}, 
    {color:'#e63946', label:'Shadow'}, {color:'#06d6a0', label:'Ally'},
    {color:'#fb8500', label:'Trickster'}
  ];
  
  let html = `
    <div class="graph-container">
      <svg class="graph-svg" viewBox="0 0 ${width} ${height}">${edgesHtml}${nodesHtml}</svg>
      <div class="graph-controls">
        <button class="btn small" onclick="renderRelationshipsView()">Refresh</button>
      </div>
    </div>
    <div class="graph-legend">
      ${legendItems.map(l => `<div class="legend-item"><div class="legend-dot" style="background:${l.color}"></div>${l.label}</div>`).join('')}
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:0.5rem 0;">
      <h3 style="font-family:var(--font-title);font-size:0.8rem;color:var(--text-muted);">Relationships (${rels.length})</h3>
      <button class="btn" onclick="addRelationship()">+ Add Relationship</button>
    </div>
  `;
  
  if (rels.length > 0) {
    html += `<div class="relationships-list">`;
    rels.forEach(r => {
      const from = chars.find(c => c.id === r.fromId);
      const to = chars.find(c => c.id === r.toId);
      const relType = VOCAB.RELATIONSHIP_TYPES[r.type];
      if (from && to) {
        html += `<div class="relationship-card" style="border-left-color:${relType?.color||'#8b949e'}">
          <span class="rel-from">${from.name}</span>
          <span class="rel-arrow">‚Üí</span>
          <span class="rel-type">${relType?.label || r.type}</span>
          <span class="rel-arrow">‚Üí</span>
          <span class="rel-to">${to.name}</span>
          <button class="rel-delete" onclick="deleteRelationship('${r.id}')" title="Delete">√ó</button>
        </div>`;
      }
    });
    html += `</div>`;
  }
  
  container.innerHTML = html;
}

window.deleteRelationship = (id) => {
  state.project.libraries.relationships = state.project.libraries.relationships.filter(r => r.id !== id);
  renderRelationshipsView();
  generateCNL();
};

window.addRelationship = () => {
  const chars = state.project.libraries.characters;
  if (chars.length < 2) { alert('Need at least 2 characters'); return; }
  
  // Group relationship types by category
  const relsByCategory = {};
  Object.entries(VOCAB.RELATIONSHIP_TYPES).forEach(([k, v]) => {
    if (!relsByCategory[v.category]) relsByCategory[v.category] = [];
    relsByCategory[v.category].push({key: k, ...v});
  });
  
  $('#modal-title').textContent = 'Add Relationship';
  $('#modal-body').innerHTML = `
    <div class="form-row">
      <div class="form-group"><label class="form-label">From</label>
      <select class="form-select" id="rel-from">${chars.map(c=>`<option value="${c.id}">${c.name} (${c.archetype||''})</option>`).join('')}</select></div>
      <div class="form-group"><label class="form-label">To</label>
      <select class="form-select" id="rel-to">${chars.map((c,i)=>`<option value="${c.id}" ${i===1?'selected':''}>${c.name} (${c.archetype||''})</option>`).join('')}</select></div>
    </div>
    <div class="form-group"><label class="form-label">Relationship Type</label>
    <select class="form-select" id="rel-type">
      ${Object.entries(relsByCategory).map(([cat, types]) => 
        `<optgroup label="${cat.charAt(0).toUpperCase() + cat.slice(1)}">${types.map(t => 
          `<option value="${t.key}">${t.label}</option>`
        ).join('')}</optgroup>`
      ).join('')}
    </select></div>
    <div class="form-hint">Tip: Relationships appear as edges in the graph above</div>`;
  $('#btn-modal-save').onclick = () => {
    const fromId = $('#rel-from').value;
    const toId = $('#rel-to').value;
    const type = $('#rel-type').value;
    if (fromId === toId) { alert('Cannot create relationship with self'); return; }
    state.project.libraries.relationships.push({id:genId(), fromId, toId, type});
    closeModal('entity-modal');
    renderRelationshipsView();
    generateCNL();
  };
  openModal('entity-modal');
};

// ==================== EMOTIONAL ARC VIEW ====================
function renderEmotionalArcView() {
  const container = $('#emotionalarc-view');
  const arc = VOCAB.NARRATIVE_ARCS[state.project.selectedArc];
  const emotionalArc = state.project.libraries.emotionalArc;
  
  if (!arc) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-text">Select a narrative arc first</div></div>`;
    return;
  }
  
  let html = `
    <div style="margin-bottom:1rem;">
      <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">
        <strong>Emotional Arc</strong> defines the overall emotional journey of your story, independent of scene-level moods.
        Each beat in your narrative arc can have an associated emotional tone.
      </p>
      <p style="font-size:0.75rem;color:var(--text-muted);">
        Arc: <strong>${arc.label}</strong> - ${arc.desc}
      </p>
    </div>
    
    <div class="arc-timeline">
      <div class="arc-timeline-header">
        <span class="arc-timeline-title">Story Beats (${arc.beats.length})</span>
      </div>
      <div class="arc-beats">
  `;
  
  arc.beats.forEach((beat, i) => {
    const savedBeat = emotionalArc.find(e => e.beatKey === beat.key);
    const selectedMood = savedBeat?.moodPreset || '';
    
    html += `
      <div class="arc-beat">
        <div class="arc-beat-position">${Math.round(beat.position * 100)}%</div>
        <div class="arc-beat-label">${beat.label}</div>
        <div class="arc-beat-desc">${beat.desc}</div>
        <div class="arc-beat-mood">
          <select onchange="setArcBeatMood('${beat.key}', this.value)">
            <option value="">-- Select mood --</option>
            ${Object.entries(VOCAB.MOOD_PRESETS).map(([k,v]) => 
              `<option value="${k}" ${selectedMood===k?'selected':''}>${v.label}</option>`
            ).join('')}
          </select>
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
    
    <div style="margin-top:1rem;padding:0.8rem;background:var(--bg-surface);border-radius:4px;">
      <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.5rem;">Emotional Progression</div>
      <div style="display:flex;gap:0.3rem;height:40px;align-items:flex-end;">
        ${arc.beats.map(beat => {
          const savedBeat = emotionalArc.find(e => e.beatKey === beat.key);
          const preset = savedBeat ? VOCAB.MOOD_PRESETS[savedBeat.moodPreset] : null;
          const height = preset ? '100%' : '20%';
          const color = preset?.color || 'var(--bg-elevated)';
          return `<div style="flex:1;height:${height};background:${color};border-radius:2px;" title="${beat.label}: ${preset?.label || 'Not set'}"></div>`;
        }).join('')}
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

window.setArcBeatMood = (beatKey, moodPreset) => {
  const existing = state.project.libraries.emotionalArc.findIndex(e => e.beatKey === beatKey);
  if (existing >= 0) {
    if (moodPreset) {
      state.project.libraries.emotionalArc[existing].moodPreset = moodPreset;
    } else {
      state.project.libraries.emotionalArc.splice(existing, 1);
    }
  } else if (moodPreset) {
    state.project.libraries.emotionalArc.push({id: genId(), beatKey, moodPreset});
  }
  renderEmotionalArcView();
  generateCNL();
};

// ==================== BLOCKS VIEW (IMPROVED) ====================
function renderBlocksView() {
  const container = $('#blocks-view');
  const usedBlocks = getUsedBlocks();
  const phases = ['opening', 'transition', 'confrontation', 'resolution', 'micro'];
  const filter = state.blocksFilter;
  
  let html = `
    <div class="blocks-filter">
      <button class="btn small ${filter==='all'?'active':''}" onclick="setBlocksFilter('all')">All</button>
      ${phases.map(p => `<button class="btn small ${filter===p?'active':''}" onclick="setBlocksFilter('${p}')">${p}</button>`).join('')}
    </div>
    <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:1rem;">
      Narrative blocks are reusable story patterns. Click a block to see details. Add blocks to scenes via right-click menu in the tree.
    </p>
  `;
  
  const filteredPhases = filter === 'all' ? phases : [filter];
  
  filteredPhases.forEach(phase => {
    const phaseBlocks = Object.entries(VOCAB.NARRATIVE_BLOCKS).filter(([k,v]) => v.phase === phase);
    if (phaseBlocks.length === 0) return;
    
    html += `<div class="blocks-section">
      <div class="blocks-section-title">${phase} (${phaseBlocks.length})</div>
      <div class="entity-grid">
    `;
    
    phaseBlocks.forEach(([k, v]) => {
      const isUsed = usedBlocks.has(k);
      html += `
        <div class="block-card ${isUsed?'used':''}" onclick="showBlockDetails('${k}')">
          <div class="block-name">${v.label}${isUsed?' ‚úì':''}</div>
          <div class="block-desc">${v.desc}</div>
          <div class="block-meta">
            <span class="block-scope">${v.scope}</span>
            ${v.suggestedMoods.map(m => `<span class="entity-tag">${m}</span>`).join('')}
          </div>
        </div>
      `;
    });
    
    html += `</div></div>`;
  });
  
  container.innerHTML = html;
}

window.setBlocksFilter = (filter) => {
  state.blocksFilter = filter;
  renderBlocksView();
};

window.showBlockDetails = (key) => {
  const block = VOCAB.NARRATIVE_BLOCKS[key];
  if (!block) return;
  
  $('#modal-title').textContent = block.label;
  $('#modal-body').innerHTML = `
    <div style="margin-bottom:1rem;">
      <div style="font-size:0.7rem;color:var(--entity-block);text-transform:uppercase;margin-bottom:0.3rem;">${block.phase} Phase</div>
      <p style="font-size:0.9rem;color:var(--text-primary);margin-bottom:0.5rem;">${block.desc}</p>
      <p style="font-size:0.75rem;color:var(--text-muted);">Scope: ${block.scope}</p>
    </div>
    <div style="margin-bottom:1rem;">
      <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.3rem;">Suggested Moods</div>
      <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
        ${block.suggestedMoods.map(m => {
          const preset = VOCAB.MOOD_PRESETS[m];
          return `<span style="padding:0.3rem 0.6rem;background:${preset?.color||'var(--bg-elevated)'};border-radius:4px;font-size:0.75rem;color:white;">${m}</span>`;
        }).join('')}
      </div>
    </div>
    <div>
      <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.3rem;">Related Themes</div>
      <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
        ${block.themes.map(t => `<span class="entity-tag">${t}</span>`).join('')}
      </div>
    </div>
  `;
  $('#btn-modal-save').style.display = 'none';
  openModal('entity-modal');
  setTimeout(() => { $('#btn-modal-save').style.display = ''; }, 100);
};

// ==================== WORLD RULES VIEW ====================
function renderWorldRulesView() {
  const container = $('#worldrules-grid');
  const rules = state.project.libraries.worldRules;
  
  let html = '';
  
  if (rules.length > 0) {
    rules.forEach(r => {
      html += `
        <div class="rule-card" onclick="editWorldRule('${r.id}')">
          <div class="rule-category">${r.category}</div>
          <div class="rule-name">${r.name}</div>
          <div class="rule-desc">${r.description}</div>
          ${r.scope ? `<div class="rule-scope">Applies to: ${r.scope}</div>` : ''}
        </div>
      `;
    });
  }
  
  html += `<div class="add-entity-card" onclick="addWorldRule()"><div class="icon">+</div><span>Add World Rule</span></div>`;
  
  container.innerHTML = html;
}

window.addWorldRule = () => {
  state.editingEntity = null;
  showWorldRuleForm(null);
};

window.editWorldRule = (id) => {
  state.editingEntity = id;
  showWorldRuleForm(state.project.libraries.worldRules.find(r => r.id === id));
};

function showWorldRuleForm(r) {
  const isEdit = !!r;
  $('#modal-title').textContent = (isEdit ? 'Edit' : 'Add') + ' World Rule';
  
  const categories = ['physics', 'magic', 'society', 'technology', 'biology', 'time', 'geography', 'other'];
  
  let html = '';
  if (isEdit) {
    html += `<div style="display:flex;justify-content:flex-end;margin-bottom:0.8rem;">
      <button class="btn danger" onclick="deleteWorldRule('${r.id}')">Delete</button></div>`;
  }
  
  html += `
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rule Name</label>
      <input class="form-input" id="rule-name" value="${r?.name||''}" placeholder="e.g., Inverse Gravity"></div>
      <div class="form-group"><label class="form-label">Category</label>
      <select class="form-select" id="rule-category">
        ${categories.map(c => `<option value="${c}" ${r?.category===c?'selected':''}>${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('')}
      </select></div>
    </div>
    <div class="form-group"><label class="form-label">Description</label>
    <textarea class="form-textarea" id="rule-desc" placeholder="Describe how this rule works in your world...">${r?.description||''}</textarea></div>
    <div class="form-group"><label class="form-label">Scope (optional)</label>
    <input class="form-input" id="rule-scope" value="${r?.scope||''}" placeholder="e.g., Shadowrealm, Night time, Underground">
    <div class="form-hint">Where or when does this rule apply? Leave empty for global rules.</div></div>
  `;
  
  $('#modal-body').innerHTML = html;
  $('#btn-modal-save').onclick = () => {
    const name = $('#rule-name').value.trim();
    if (!name) { alert('Name is required'); return; }
    
    const rule = isEdit ? state.project.libraries.worldRules.find(x => x.id === state.editingEntity) : {id: genId()};
    rule.name = name;
    rule.category = $('#rule-category').value;
    rule.description = $('#rule-desc').value.trim();
    rule.scope = $('#rule-scope').value.trim();
    
    if (!isEdit) state.project.libraries.worldRules.push(rule);
    closeModal('entity-modal');
    renderWorldRulesView();
    updateStats();
    generateCNL();
  };
  openModal('entity-modal');
}

window.deleteWorldRule = (id) => {
  if (!confirm('Delete this rule?')) return;
  state.project.libraries.worldRules = state.project.libraries.worldRules.filter(r => r.id !== id);
  closeModal('entity-modal');
  renderWorldRulesView();
  updateStats();
  generateCNL();
};

// ==================== CNL GENERATION ====================
function generateCNL() {
  let cnl = `// Auto-generated CNL\n// ${state.project.name}\n// Arc: ${state.project.selectedArc}\n\n`;
  const {characters, locations, objects, moods, emotionalArc, themes, relationships, worldRules} = state.project.libraries;
  
  if (worldRules.length) {
    cnl += '// World Rules\n';
    worldRules.forEach(r => {
      cnl += `World has rule ${fid(r.name)}\n`;
      cnl += `${fid(r.name)} has category ${r.category}\n`;
      if (r.description) cnl += `${fid(r.name)} has description "${r.description}"\n`;
      if (r.scope) cnl += `${fid(r.name)} applies to ${fid(r.scope)}\n`;
    });
    cnl += '\n';
  }
  
  if (characters.length) {
    cnl += '// Characters\n';
    characters.forEach(c => {
      cnl += `${fid(c.name)} is ${c.archetype || 'character'}\n`;
      c.traits?.forEach(t => cnl += `${fid(c.name)} has trait ${t}\n`);
    });
    cnl += '\n';
  }
  if (relationships.length) {
    cnl += '// Relationships\n';
    relationships.forEach(r => {
      const from = characters.find(c=>c.id===r.fromId);
      const to = characters.find(c=>c.id===r.toId);
      if (from && to) cnl += `${fid(from.name)} ${r.type.replace(/_/g,' ')} ${fid(to.name)}\n`;
    });
    cnl += '\n';
  }
  if (locations.length) {
    cnl += '// Locations\n';
    locations.forEach(l => {
      cnl += `${fid(l.name)} is location\n`;
      if (l.geography) cnl += `${fid(l.name)} has geography ${l.geography}\n`;
      if (l.time) cnl += `${fid(l.name)} has era ${l.time}\n`;
      l.characteristics?.forEach(c => cnl += `${fid(l.name)} has characteristic ${c}\n`);
    });
    cnl += '\n';
  }
  if (objects.length) {
    cnl += '// Objects\n';
    objects.forEach(o => {
      cnl += `${fid(o.name)} is ${o.objectType || 'object'}\n`;
      if (o.significance) cnl += `${fid(o.name)} has significance ${o.significance}\n`;
      if (o.ownerId) {
        const owner = characters.find(c=>c.id===o.ownerId);
        if (owner) cnl += `${fid(owner.name)} owns ${fid(o.name)}\n`;
      }
    });
    cnl += '\n';
  }
  if (moods.length) {
    cnl += '// Scene Moods\n';
    moods.forEach(m => {
      cnl += `${fid(m.name)} is mood\n`;
      Object.entries(m.emotions||{}).forEach(([e,i]) => cnl += `${fid(m.name)} has emotion ${e} intensity ${i}\n`);
    });
    cnl += '\n';
  }
  if (emotionalArc.length) {
    cnl += '// Emotional Arc\n';
    emotionalArc.forEach(ea => {
      cnl += `Story beat ${ea.beatKey} has mood ${ea.moodPreset}\n`;
    });
    cnl += '\n';
  }
  if (themes.length) {
    cnl += '// Themes\n';
    themes.forEach(t => { cnl += `Story has theme ${fid(t.name)}\n`; });
    cnl += '\n';
  }
  if (state.project.structure) {
    cnl += '// Structure\n' + genNodeCNL(state.project.structure, 0);
  }
  $('#cnl-output').textContent = cnl;
  return cnl;
}

function fid(n) { return n && (n.includes(' ') || /[^a-zA-Z0-9_]/.test(n)) ? `"${n}"` : n; }
function genNodeCNL(n, d) {
  const ind = '  '.repeat(d);
  let cnl = '';
  if (['book','chapter','scene'].includes(n.type)) {
    cnl += `${ind}${fid(n.name)} group begin\n`;
    if (n.title) cnl += `${ind}  ${fid(n.name)} has title "${n.title}"\n`;
    (n.children||[]).forEach(c => {
      if (c.type === 'action') {
        const act = c.actionData;
        cnl += `${ind}  ${fid(act.subject)} ${act.action.replace(/_/g,' ')}${act.target ? ' '+fid(act.target) : ''}\n`;
      } else if (c.type.endsWith('-ref')) {
        cnl += `${ind}  ${fid(n.name)} includes ${c.type.replace('-ref','')} ${fid(c.name)}\n`;
      } else {
        cnl += genNodeCNL(c, d+1);
      }
    });
    cnl += `${ind}${fid(n.name)} group end\n`;
  }
  return cnl;
}

// ==================== RANDOM GENERATOR ====================
function generateRandomStory() {
  state.project.libraries = { characters: [], locations: [], objects: [], moods: [], emotionalArc: [], themes: [], relationships: [], worldRules: [] };
  
  // Use selected arc
  state.project.selectedArc = $('#arc-select').value;
  const arc = VOCAB.NARRATIVE_ARCS[state.project.selectedArc];
  
  // Generate 4-6 characters with archetypes
  const archetypeList = ['hero','mentor','shadow','ally','trickster','ally'];
  pickN(archetypeList, 4 + Math.floor(Math.random()*3)).forEach(arch => {
    const a = VOCAB.CHARACTER_ARCHETYPES[arch];
    const name = pick(VOCAB.NAMES.characters.filter(n => !state.project.libraries.characters.find(c=>c.name===n)));
    if (!name) return;
    state.project.libraries.characters.push({
      id: genId(),
      name: name,
      archetype: arch,
      traits: [...(a.suggestedTraits||[]), ...pickN(Object.keys(VOCAB.CHARACTER_TRAITS), 2)]
    });
  });
  
  // Generate relationships between characters
  const chars = state.project.libraries.characters;
  const hero = chars.find(c => c.archetype === 'hero');
  chars.forEach(c => {
    if (c === hero) return;
    const relType = c.archetype === 'mentor' ? 'mentor_student' : 
                    c.archetype === 'shadow' ? 'rivals' :
                    c.archetype === 'ally' ? 'friends' :
                    c.archetype === 'trickster' ? 'acquaintances' : 'acquaintances';
    state.project.libraries.relationships.push({
      id: genId(),
      fromId: hero?.id,
      toId: c.id,
      type: relType
    });
  });
  
  // Generate 4-5 locations
  const geos = Object.keys(VOCAB.LOCATION_GEOGRAPHY);
  pickN(geos, 4 + Math.floor(Math.random()*2)).forEach(geo => {
    const name = pick(VOCAB.NAMES.locations.filter(n => !state.project.libraries.locations.find(l=>l.name===n)));
    if (!name) return;
    state.project.libraries.locations.push({
      id: genId(),
      name: name,
      geography: geo,
      time: pick(Object.keys(VOCAB.LOCATION_TIME)),
      characteristics: pickN(Object.keys(VOCAB.LOCATION_CHARACTERISTICS), 2)
    });
  });
  
  // Generate 2-3 objects
  pickN(VOCAB.NAMES.objects, 2 + Math.floor(Math.random()*2)).forEach(name => {
    state.project.libraries.objects.push({
      id: genId(),
      name: name,
      objectType: pick(Object.keys(VOCAB.OBJECT_TYPES)),
      significance: pick(['important','central']),
      ownerId: Math.random() > 0.5 ? hero?.id : null
    });
  });
  
  // Generate 3 scene moods
  pickN(Object.keys(VOCAB.MOOD_PRESETS), 3).forEach(k => {
    const preset = VOCAB.MOOD_PRESETS[k];
    state.project.libraries.moods.push({
      id: genId(),
      name: preset.label,
      emotions: {...preset.emotions}
    });
  });
  
  // Generate emotional arc (global)
  arc.beats.forEach(beat => {
    const suggestedMood = pick(Object.keys(VOCAB.MOOD_PRESETS));
    state.project.libraries.emotionalArc.push({
      id: genId(),
      beatKey: beat.key,
      moodPreset: suggestedMood
    });
  });
  
  // Generate 2 themes
  pickN(Object.keys(VOCAB.THEMES), 2).forEach(k => {
    const t = VOCAB.THEMES[k];
    state.project.libraries.themes.push({id:genId(), name:t.label, themeKey:k});
  });
  
  // Generate 1-2 world rules
  const ruleExamples = [
    {name: 'Magic requires sacrifice', category: 'magic', description: 'All magic has a cost - blood, memories, or life force'},
    {name: 'Dragons are extinct', category: 'biology', description: 'The great dragons died out centuries ago, only their bones remain'},
    {name: 'No direct sunlight', category: 'physics', description: 'The world is shrouded in eternal twilight'},
    {name: 'Telepathy exists', category: 'magic', description: 'Some gifted individuals can read surface thoughts'},
    {name: 'Iron repels spirits', category: 'magic', description: 'Cold iron creates a barrier against supernatural entities'}
  ];
  pickN(ruleExamples, 1 + Math.floor(Math.random()*2)).forEach(r => {
    state.project.libraries.worldRules.push({id: genId(), ...r});
  });
  
  // Generate structure based on arc
  const locs = state.project.libraries.locations;
  const moods = state.project.libraries.moods;
  const objs = state.project.libraries.objects;
  
  state.project.structure = {
    id: genId(),
    type: 'book',
    name: 'Book',
    title: state.project.name,
    children: []
  };
  
  // Group beats into chapters (3-4 beats per chapter)
  const beatsPerChapter = 3;
  for (let i = 0; i < arc.beats.length; i += beatsPerChapter) {
    const chapterBeats = arc.beats.slice(i, i + beatsPerChapter);
    const chapterNum = Math.floor(i / beatsPerChapter) + 1;
    
    const chapter = {
      id: genId(),
      type: 'chapter',
      name: `Ch${chapterNum}`,
      title: chapterBeats[0]?.label || '',
      children: []
    };
    
    // Create scene for each beat
    chapterBeats.forEach((beat, j) => {
      const scene = {
        id: genId(),
        type: 'scene',
        name: `Sc${chapterNum}.${j+1}`,
        title: beat.label,
        children: []
      };
      
      // Add character refs (hero always, plus 1-2 others)
      if (hero) scene.children.push({id:genId(), type:'character-ref', name:hero.name, refId:hero.id});
      const otherChars = chars.filter(c => c !== hero);
      pickN(otherChars, 1 + Math.floor(Math.random()*2)).forEach(c => {
        scene.children.push({id:genId(), type:'character-ref', name:c.name, refId:c.id});
      });
      
      // Add location
      if (locs.length) {
        const loc = pick(locs);
        scene.children.push({id:genId(), type:'location-ref', name:loc.name, refId:loc.id});
      }
      
      // Add mood
      if (moods.length) {
        const mood = pick(moods);
        scene.children.push({id:genId(), type:'mood-ref', name:mood.name, refId:mood.id});
      }
      
      // Add narrative block
      const blockKey = beat.key.replace(/_/g,'_');
      const matchingBlock = Object.entries(VOCAB.NARRATIVE_BLOCKS).find(([k,v]) => k.includes(blockKey.split('_')[0]));
      if (matchingBlock) {
        scene.children.push({id:genId(), type:'block-ref', name:matchingBlock[1].label, blockKey:matchingBlock[0]});
      }
      
      // Add 2-3 actions
      const actionKeys = Object.keys(VOCAB.ACTIONS);
      pickN(actionKeys, 2 + Math.floor(Math.random()*2)).forEach(actKey => {
        const act = VOCAB.ACTIONS[actKey];
        const subject = hero?.name || pick(chars)?.name;
        let target = '';
        if (act.requires.length > 1) {
          const targetType = act.requires[1];
          if (targetType.includes('character')) target = pick(chars.filter(c=>c.name!==subject))?.name || '';
          else if (targetType.includes('location')) target = pick(locs)?.name || '';
          else if (targetType.includes('object')) target = pick(objs)?.name || '';
        }
        scene.children.push({
          id: genId(),
          type: 'action',
          name: `${subject} ${actKey}`,
          actionData: { subject, action: actKey, target }
        });
      });
      
      chapter.children.push(scene);
    });
    
    state.project.structure.children.push(chapter);
  }
  
  renderTree();
  ['characters','locations','objects','moods','themes'].forEach(renderEntityGrid);
  renderRelationshipsView();
  renderEmotionalArcView();
  renderBlocksView();
  renderWorldRulesView();
  evaluateMetrics();
}

// ==================== METRICS (OBJECTIVE) ====================
function evaluateMetrics() {
  generateCNL();
  const {characters, locations, objects, moods, emotionalArc, themes, relationships, worldRules} = state.project.libraries;
  const sceneCount = countType(state.project.structure, 'scene');
  const chapterCount = countType(state.project.structure, 'chapter');
  const blockCount = countType(state.project.structure, 'block-ref');
  const actionCount = countType(state.project.structure, 'action');
  const charRefs = countType(state.project.structure, 'character-ref');
  const locRefs = countType(state.project.structure, 'location-ref');
  const moodRefs = countType(state.project.structure, 'mood-ref');
  
  const metrics = {};
  
  // OBJECTIVE CALCULATIONS - No random, no inflation
  
  // 1. Completeness - Do we have required elements?
  const hasChars = characters.length >= 2 ? 1 : characters.length / 2;
  const hasLocs = locations.length >= 2 ? 1 : locations.length / 2;
  const hasStructure = sceneCount >= 3 ? 1 : sceneCount / 3;
  const hasThemes = themes.length >= 1 ? 1 : 0;
  const hasArc = emotionalArc.length >= 3 ? 1 : emotionalArc.length / 3;
  metrics.completeness = (hasChars * 0.25 + hasLocs * 0.15 + hasStructure * 0.3 + hasThemes * 0.15 + hasArc * 0.15);
  
  // 2. Coherence Score (CS) - Entity usage and references
  const totalEntities = characters.length + locations.length;
  const totalRefs = charRefs + locRefs;
  const entityUsageRatio = totalEntities > 0 ? Math.min(1, totalRefs / (totalEntities * Math.max(1, sceneCount) * 0.3)) : 0;
  const hasRelationships = relationships.length >= Math.max(1, characters.length - 1) ? 1 : relationships.length / Math.max(1, characters.length - 1);
  const hasBlocks = blockCount >= Math.max(1, sceneCount * 0.5) ? 1 : blockCount / Math.max(1, sceneCount * 0.5);
  metrics.cs = entityUsageRatio * 0.4 + hasRelationships * 0.3 + hasBlocks * 0.3;
  
  // 3. Character Attribute Drift (CAD) - Lower is better
  // Check if characters have consistent traits
  const traitCount = characters.reduce((sum, c) => sum + (c.traits?.length || 0), 0);
  const avgTraits = characters.length > 0 ? traitCount / characters.length : 0;
  // CAD is low when chars have 3+ traits each
  metrics.cad = avgTraits >= 3 ? 0.05 : avgTraits >= 2 ? 0.10 : avgTraits >= 1 ? 0.15 : 0.25;
  
  // 4. Compliance Adherence Rate (CAR) - Check for orphan refs
  const orphanRefs = countOrphanRefs(state.project.structure, state.project.libraries);
  const totalRefsCount = charRefs + locRefs + countType(state.project.structure, 'object-ref') + moodRefs;
  metrics.car = totalRefsCount > 0 ? Math.max(0, (totalRefsCount - orphanRefs) / totalRefsCount) : 1;
  
  // 5. Originality Index (OI) - Variety of elements used
  const uniqueBlocks = new Set();
  countBlockTypes(state.project.structure, uniqueBlocks);
  const uniqueActions = new Set();
  countActionTypes(state.project.structure, uniqueActions);
  const blockVariety = uniqueBlocks.size / Math.max(1, Object.keys(VOCAB.NARRATIVE_BLOCKS).length * 0.3);
  const actionVariety = uniqueActions.size / Math.max(1, Object.keys(VOCAB.ACTIONS).length * 0.1);
  const themeVariety = themes.length >= 2 ? 1 : themes.length * 0.5;
  metrics.oi = Math.min(1, blockVariety * 0.4 + actionVariety * 0.3 + themeVariety * 0.3);
  
  // 6. Emotional Arc Profile (EAP) - Arc coverage
  const arc = VOCAB.NARRATIVE_ARCS[state.project.selectedArc];
  const arcCoverage = arc ? emotionalArc.length / arc.beats.length : 0;
  const moodVariety = moods.length / 5; // Target: 5 moods
  const moodUsage = sceneCount > 0 ? moodRefs / sceneCount : 0;
  metrics.eap = Math.min(1, arcCoverage * 0.5 + Math.min(1, moodVariety) * 0.25 + Math.min(1, moodUsage) * 0.25);
  
  // 7. Explainability Score - Based on documentation completeness
  const hasArcDef = state.project.selectedArc ? 0.2 : 0;
  const hasThemeDef = themes.length > 0 ? 0.2 : 0;
  const hasRelDef = relationships.length > 0 ? 0.2 : 0;
  const hasRulesDef = worldRules.length > 0 ? 0.2 : 0;
  const hasEmotionalArcDef = emotionalArc.length >= 3 ? 0.2 : emotionalArc.length * 0.066;
  metrics.explainability = (hasArcDef + hasThemeDef + hasRelDef + hasRulesDef + hasEmotionalArcDef) * 5; // Scale to 0-5
  
  // 8. Retrieval Quality (RQ) - Naming clarity
  const allEntities = [...characters, ...locations, ...objects, ...moods];
  const namedWell = allEntities.filter(e => e.name && e.name.length >= 3 && e.name !== 'undefined').length;
  metrics.rq = allEntities.length > 0 ? namedWell / allEntities.length : 0;
  
  // 9. CNL Parse Success Rate (CPSR)
  const cnl = $('#cnl-output').textContent;
  const cnlLines = cnl.split('\n').filter(l => l.trim() && !l.trim().startsWith('//'));
  const validLines = cnlLines.filter(l => /^[\s]*[\w"]+\s+(is|has|group|includes|owns|applies|beat)/.test(l));
  metrics.cpsr = cnlLines.length > 0 ? validLines.length / cnlLines.length : 0;
  
  // 10. Constraint Satisfaction Accuracy (CSA)
  const validRefs = totalRefsCount - orphanRefs;
  metrics.csa = totalRefsCount > 0 ? validRefs / totalRefsCount : 1;
  
  // 11. Narrative Quality Score (NQS) - Composite
  metrics.nqs = 
    metrics.completeness * 0.15 +
    metrics.cs * 0.20 + 
    (1 - Math.min(1, metrics.cad * 4)) * 0.10 + // Invert CAD (lower is better)
    metrics.oi * 0.10 + 
    metrics.eap * 0.15 + 
    metrics.cpsr * 0.10 + 
    metrics.csa * 0.10 + 
    (metrics.explainability / 5) * 0.10;
  
  renderMetrics(metrics, {sceneCount, chapterCount, blockCount, actionCount, charRefs, locRefs});
}

function countOrphanRefs(node, libraries) {
  if (!node) return 0;
  let orphans = 0;
  if (node.type === 'character-ref' && node.refId && !libraries.characters.find(c => c.id === node.refId)) orphans++;
  if (node.type === 'location-ref' && node.refId && !libraries.locations.find(l => l.id === node.refId)) orphans++;
  if (node.type === 'object-ref' && node.refId && !libraries.objects.find(o => o.id === node.refId)) orphans++;
  if (node.type === 'mood-ref' && node.refId && !libraries.moods.find(m => m.id === node.refId)) orphans++;
  (node.children || []).forEach(c => orphans += countOrphanRefs(c, libraries));
  return orphans;
}

function countBlockTypes(n, set) {
  if (!n) return;
  if (n.type === 'block-ref' && n.blockKey) set.add(n.blockKey);
  (n.children||[]).forEach(c => countBlockTypes(c, set));
}

function countActionTypes(n, set) {
  if (!n) return;
  if (n.type === 'action' && n.actionData?.action) set.add(n.actionData.action);
  (n.children||[]).forEach(c => countActionTypes(c, set));
}

function countType(n, t) {
  if (!n) return 0;
  let c = n.type === t ? 1 : 0;
  (n.children||[]).forEach(ch => c += countType(ch, t));
  return c;
}

function renderMetrics(m, counts) {
  const isEmpty = !state.project.structure && state.project.libraries.characters.length === 0;
  
  if (isEmpty) {
    $('#metrics-content').innerHTML = `
      <div class="empty-state" style="padding:1rem;">
        <div class="empty-state-text">No data yet</div>
        <div class="empty-state-hint">Click Random or start building your story</div>
      </div>
    `;
    return;
  }
  
  // Summary metrics
  const summaryMetrics = [
    {k:'nqs', n:'Narrative Quality', threshold: 0.70, desc: 'Overall story quality'},
    {k:'completeness', n:'Completeness', threshold: 0.80, desc: 'Required elements present'},
    {k:'cs', n:'Coherence', threshold: 0.75, desc: 'Entity usage & structure'},
    {k:'eap', n:'Emotional Arc', threshold: 0.70, desc: 'Arc coverage & moods'}
  ];
  
  // Detailed metrics
  const detailedMetrics = [
    {k:'cad', n:'Character Drift', threshold: 0.15, inverse: true, desc: 'Trait consistency'},
    {k:'car', n:'Compliance', threshold: 0.95, desc: 'Valid references'},
    {k:'oi', n:'Originality', threshold: 0.50, desc: 'Variety of elements'},
    {k:'cpsr', n:'Parse Success', threshold: 0.90, desc: 'Valid CNL syntax'},
    {k:'csa', n:'Constraints', threshold: 0.95, desc: 'Satisfied constraints'},
    {k:'rq', n:'Retrieval', threshold: 0.80, desc: 'Naming quality'},
    {k:'explainability', n:'Explainability', threshold: 3.5, unit: '/5', isRating: true, desc: 'Documentation level'}
  ];
  
  let html = `<div class="metrics-section">
    <div class="metrics-section-title">Summary</div>
    ${summaryMetrics.map(d => {
      const v = m[d.k]||0;
      const cls = v >= d.threshold ? 'good' : v >= d.threshold * 0.7 ? 'warn' : v > 0 ? 'bad' : 'neutral';
      return `<div class="metric-card">
        <div class="metric-header"><span class="metric-name">${d.n}</span><span class="metric-value ${cls}">${(v*100).toFixed(0)}%</span></div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:${v*100}%;background:var(--accent-${cls==='good'?'emerald':cls==='warn'?'amber':cls==='bad'?'rose':'sky'})"></div></div>
        <div class="metric-detail">${d.desc}</div>
      </div>`;
    }).join('')}
  </div>`;
  
  html += `<div class="metrics-section">
    <div class="metrics-section-title">Detailed Analysis</div>
    ${detailedMetrics.map(d => {
      const v = m[d.k]||0;
      const pass = d.inverse ? v <= d.threshold : v >= d.threshold;
      const hasData = d.inverse ? v < 0.5 : v > 0;
      let displayV;
      if (d.isRating) {
        displayV = v.toFixed(1) + (d.unit || '');
      } else if (d.inverse) {
        displayV = v.toFixed(2);
      } else {
        displayV = (v * 100).toFixed(0) + '%';
      }
      const thresholdDisplay = d.inverse ? `‚â§ ${d.threshold}` : d.isRating ? `‚â• ${d.threshold}${d.unit||''}` : `‚â• ${(d.threshold*100).toFixed(0)}%`;
      const statusClass = !hasData ? 'na' : pass ? 'pass' : 'fail';
      const statusIcon = !hasData ? '‚óã' : pass ? '‚úì' : '‚úó';
      return `<div class="metric-card">
        <div class="metric-header"><span class="metric-name">${d.n}</span><span class="metric-value ${pass?'good':'bad'}">${displayV}</span></div>
        <div class="metric-status ${statusClass}"><span>${statusIcon}</span> ${thresholdDisplay}</div>
        <div class="metric-detail">${d.desc}</div>
      </div>`;
    }).join('')}
  </div>`;
  
  // Stats breakdown
  html += `<div class="metrics-section">
    <div class="metrics-section-title">Structure</div>
    <div class="metric-breakdown">
      Chapters: ${counts.chapterCount}<br>
      Scenes: ${counts.sceneCount}<br>
      Blocks: ${counts.blockCount}<br>
      Actions: ${counts.actionCount}<br>
      Char refs: ${counts.charRefs}<br>
      Loc refs: ${counts.locRefs}
    </div>
  </div>`;
  
  $('#metrics-content').innerHTML = html;
}

function updateStats() {
  $('#stat-chars').textContent = state.project.libraries.characters.length;
  $('#stat-locs').textContent = state.project.libraries.locations.length;
  $('#stat-scenes').textContent = countType(state.project.structure, 'scene');
  $('#stat-rules').textContent = state.project.libraries.worldRules.length;
}

// ==================== PERSISTENCE ====================
function exportCNL() {
  const cnl = generateCNL();
  const blob = new Blob([cnl], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (state.project.name||'story').replace(/[^a-z0-9]/gi,'_')+'.cnl';
  a.click();
}

function newProject() {
  if (!confirm('Create new project? All unsaved changes will be lost.')) return;
  state.project = {id:null, name:'Untitled Story', selectedArc:'heros_journey', libraries:{characters:[],locations:[],objects:[],moods:[],emotionalArc:[],themes:[],relationships:[],worldRules:[]}, structure:null};
  $('#project-name').value = state.project.name;
  $('#arc-select').value = state.project.selectedArc;
  renderTree();
  ['characters','locations','objects','moods','themes'].forEach(renderEntityGrid);
  renderRelationshipsView();
  renderEmotionalArcView();
  renderBlocksView();
  renderWorldRulesView();
  renderEmptyMetrics();
}

function renderEmptyMetrics() {
  $('#metrics-content').innerHTML = `
    <div class="empty-state" style="padding:1rem;">
      <div class="empty-state-text">No data yet</div>
      <div class="empty-state-hint">Click Random or start building</div>
    </div>
  `;
}

// ==================== INIT ====================
$('#btn-random').onclick = generateRandomStory;
$('#btn-new').onclick = newProject;
$('#btn-export').onclick = exportCNL;
$('#btn-evaluate').onclick = evaluateMetrics;
$('#btn-add-root').onclick = () => { if (!state.project.structure) { state.project.structure = {id:genId(),type:'book',name:'Book',title:state.project.name,children:[]}; renderTree(); }};
$('#arc-select').onchange = (e) => { 
  state.project.selectedArc = e.target.value; 
  renderEmotionalArcView();
  generateCNL(); 
};

$$('.tab').forEach(tab => tab.onclick = () => {
  $$('.tab').forEach(t=>t.classList.remove('active'));
  $$('.view').forEach(v=>v.classList.remove('active'));
  tab.classList.add('active');
  $(`#view-${tab.dataset.view}`).classList.add('active');
  if (tab.dataset.view === 'relationships') renderRelationshipsView();
  if (tab.dataset.view === 'emotionalarc') renderEmotionalArcView();
  if (tab.dataset.view === 'blocks') renderBlocksView();
  if (tab.dataset.view === 'worldrules') renderWorldRulesView();
});

['characters','locations','objects','moods','themes'].forEach(renderEntityGrid);
renderTree();
renderRelationshipsView();
renderEmotionalArcView();
renderBlocksView();
renderWorldRulesView();
renderEmptyMetrics();
  </script>
</body>
</html>
