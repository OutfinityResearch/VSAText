<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCRIPTA Dashboard</title>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-tertiary: #0f3460;
      --text-primary: #eee;
      --text-secondary: #aaa;
      --accent: #e94560;
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #ef4444;
      --info: #3b82f6;
      --border: #333;
      /* JSON syntax colors */
      --json-key: #9cdcfe;
      --json-string: #ce9178;
      --json-number: #b5cea8;
      --json-boolean: #569cd6;
      --json-null: #569cd6;
      --json-bracket: #ffd700;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 350px;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }
    
    /* Header */
    header {
      grid-column: 1 / -1;
      background: var(--bg-secondary);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent);
    }
    
    .logo span {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .header-tabs {
      display: flex;
      gap: 0.5rem;
    }
    
    .header-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    
    .header-tab:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }
    
    .header-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 1rem;
    }
    
    .sidebar h2 {
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }
    
    .example-group {
      margin-bottom: 1.5rem;
    }
    
    .example-group h3 {
      font-size: 0.75rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
    }
    
    .example-btn, .spec-item {
      width: 100%;
      text-align: left;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-primary);
      padding: 0.625rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s;
      margin-bottom: 0.25rem;
    }
    
    .example-btn:hover, .spec-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    
    .example-btn.active, .spec-item.active {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }
    
    /* Main content */
    main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .view {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow: hidden;
    }
    
    .view.active {
      display: flex;
    }
    
    .tabs {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    
    .tab:hover {
      color: var(--text-primary);
    }
    
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }
    
    .panel:last-child {
      border-right: none;
    }
    
    .panel-header {
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 1rem;
    }
    
    textarea {
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.8125rem;
      padding: 1rem;
      resize: none;
      line-height: 1.5;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* JSON syntax highlighting */
    .json-view {
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.8125rem;
      padding: 1rem;
      line-height: 1.5;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .json-key { color: var(--json-key); }
    .json-string { color: var(--json-string); }
    .json-number { color: var(--json-number); }
    .json-boolean { color: var(--json-boolean); }
    .json-null { color: var(--json-null); }
    .json-bracket { color: var(--json-bracket); }
    .json-punctuation { color: var(--text-secondary); }
    
    .run-btn, .action-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    
    .run-btn:hover, .action-btn:hover {
      filter: brightness(1.1);
    }
    
    .run-btn:disabled, .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .action-btn.secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
    }
    
    /* Logs panel */
    .logs-panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .logs-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logs-header h2 {
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .logs-controls {
      display: flex;
      gap: 0.5rem;
    }
    
    .logs-controls select, .logs-controls button {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.375rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .logs-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    
    .log-entry {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      margin-bottom: 0.25rem;
      font-family: 'Fira Code', monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      border-left: 3px solid transparent;
    }
    
    .log-entry.DEBUG { border-left-color: var(--text-secondary); }
    .log-entry.INFO { border-left-color: var(--info); }
    .log-entry.WARN { border-left-color: var(--warning); background: rgba(251, 191, 36, 0.1); }
    .log-entry.ERROR { border-left-color: var(--error); background: rgba(239, 68, 68, 0.1); }
    .log-entry.FATAL { border-left-color: var(--error); background: rgba(239, 68, 68, 0.2); }
    
    .log-time { color: var(--text-secondary); }
    .log-level { font-weight: 600; margin: 0 0.5rem; }
    .log-level.DEBUG { color: var(--text-secondary); }
    .log-level.INFO { color: var(--info); }
    .log-level.WARN { color: var(--warning); }
    .log-level.ERROR { color: var(--error); }
    .log-level.FATAL { color: var(--error); }
    .log-message { color: var(--text-primary); }
    .log-context { color: var(--text-secondary); margin-top: 0.25rem; font-size: 0.6875rem; }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    
    .status-badge.success { background: rgba(74, 222, 128, 0.2); color: var(--success); }
    .status-badge.error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    .status-badge.warning { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--text-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* CNL Studio specific styles */
    .cnl-studio {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .cnl-row {
      display: flex;
      flex: 1;
      min-height: 0;
    }
    
    .cnl-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      min-width: 0;
    }
    
    .cnl-panel:last-child {
      border-right: none;
    }
    
    .cnl-output {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      font-family: 'Fira Code', monospace;
      font-size: 0.8125rem;
      line-height: 1.6;
      overflow: auto;
      height: 100%;
      white-space: pre-wrap;
    }
    
    .cnl-statement {
      margin-bottom: 0.25rem;
    }
    
    .cnl-predicate { color: var(--accent); font-weight: 600; }
    .cnl-args { color: var(--json-string); }
    .cnl-valid { color: var(--success); }
    .cnl-invalid { color: var(--error); }
    
    .specs-list {
      padding: 0.5rem;
    }
    
    .spec-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .spec-card:hover {
      border-color: var(--accent);
    }
    
    .spec-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    
    .spec-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    
    .spec-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .spec-themes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }
    
    .spec-theme {
      background: var(--bg-secondary);
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--accent);
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }
    
    .button-group {
      display: flex;
      gap: 0.5rem;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 240px 1fr 300px;
      }
    }
    
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr auto;
      }
      
      .sidebar {
        display: flex;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      
      .logs-panel {
        border-left: none;
        border-top: 1px solid var(--border);
        max-height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>SCRIPTA</h1>
        <span>Dashboard v0.2</span>
      </div>
      <div class="header-tabs">
        <button class="header-tab active" data-view="api">API Explorer</button>
        <button class="header-tab" data-view="cnl">CNL Studio</button>
      </div>
      <div class="status">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Connected</span>
      </div>
    </header>
    
    <!-- API Explorer Sidebar -->
    <aside class="sidebar" id="api-sidebar">
      <h2>API Examples</h2>
      
      <div class="example-group">
        <h3>CNL Service</h3>
        <button class="example-btn" data-example="cnl-validate">Validate CNL</button>
        <button class="example-btn" data-example="cnl-translate">Translate NL to CNL</button>
      </div>
      
      <div class="example-group">
        <h3>VSA/HDC Service</h3>
        <button class="example-btn" data-example="vsa-encode">Encode Text</button>
        <button class="example-btn" data-example="vsa-similarity">Compare Similarity</button>
      </div>
      
      <div class="example-group">
        <h3>Specs &amp; Planning</h3>
        <button class="example-btn" data-example="create-spec">Create Spec</button>
        <button class="example-btn" data-example="create-plan">Create Plan</button>
      </div>
      
      <div class="example-group">
        <h3>Generation</h3>
        <button class="example-btn" data-example="generate">Generate Content</button>
        <button class="example-btn" data-example="full-pipeline">Run Full Pipeline</button>
      </div>
      
      <div class="example-group">
        <h3>Verification</h3>
        <button class="example-btn" data-example="verify">Verify Content</button>
        <button class="example-btn" data-example="guardrail">Run Guardrails</button>
      </div>
      
      <div class="example-group">
        <h3>Evaluation</h3>
        <button class="example-btn" data-example="evaluate">Evaluate Quality</button>
        <button class="example-btn" data-example="review">Literary Review</button>
      </div>
      
      <div class="example-group">
        <h3>Other Services</h3>
        <button class="example-btn" data-example="research">Research Query</button>
        <button class="example-btn" data-example="explain">Explain Decision</button>
        <button class="example-btn" data-example="reverse">Reverse Engineer</button>
        <button class="example-btn" data-example="compliance">Compliance Report</button>
      </div>
      
      <div class="example-group">
        <h3>Audit</h3>
        <button class="example-btn" data-example="audit-logs">View Audit Logs</button>
        <button class="example-btn" data-example="audit-verify">Verify Audit Chain</button>
      </div>
    </aside>
    
    <!-- CNL Studio Sidebar -->
    <aside class="sidebar" id="cnl-sidebar" style="display: none;">
      <h2>Specifications</h2>
      <div class="button-group" style="margin-bottom: 1rem;">
        <button class="action-btn" id="refresh-specs" style="flex: 1; padding: 0.5rem;">Refresh</button>
      </div>
      <div id="specs-list" class="specs-list">
        <div class="empty-state">No specs yet. Create one!</div>
      </div>
    </aside>
    
    <main>
      <!-- API Explorer View -->
      <div class="view active" id="api-view">
        <div class="tabs">
          <button class="tab active" data-tab="request">Request</button>
          <button class="tab" data-tab="response">Response</button>
        </div>
        
        <div class="content">
          <div class="panel" id="request-panel">
            <div class="panel-header">
              <span>Request</span>
              <div>
                <select id="method-select">
                  <option value="GET">GET</option>
                  <option value="POST" selected>POST</option>
                  <option value="PUT">PUT</option>
                  <option value="DELETE">DELETE</option>
                </select>
                <input type="text" id="endpoint-input" placeholder="/v1/..." 
                       style="background: var(--bg-primary); border: 1px solid var(--border); 
                              color: var(--text-primary); padding: 0.375rem 0.75rem; 
                              border-radius: 4px; font-size: 0.75rem; width: 200px; margin-left: 0.5rem;">
              </div>
            </div>
            <div class="panel-content">
              <textarea id="request-body" placeholder="Enter JSON request body..."></textarea>
            </div>
            <div class="panel-header" style="justify-content: flex-end; border-top: 1px solid var(--border); border-bottom: none;">
              <button class="run-btn" id="run-btn">
                <span id="run-text">Run Request</span>
              </button>
            </div>
          </div>
          
          <div class="panel" id="response-panel">
            <div class="panel-header">
              <span>Response</span>
              <span id="response-status"></span>
            </div>
            <div class="panel-content">
              <div class="json-view" id="response-body">Click "Run Request" to see the response...</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- CNL Studio View -->
      <div class="view" id="cnl-view">
        <div class="cnl-studio">
          <div class="cnl-row">
            <!-- Natural Language Input -->
            <div class="cnl-panel">
              <div class="panel-header">
                <span>Natural Language Input</span>
                <span style="font-size: 0.6875rem; text-transform: none;">Describe your story constraints</span>
              </div>
              <div class="panel-content">
                <textarea id="nl-input" placeholder="Enter your story description in natural language...

Example:
The protagonist Anna must be courageous and protective. 
She needs to save her brother Marcus from danger.
The story should have a hopeful ending with themes of courage and family.
A dramatic storm must appear in the third scene.
The setting is a small coastal village in modern times."></textarea>
              </div>
              <div class="panel-header" style="border-top: 1px solid var(--border); border-bottom: none;">
                <div class="button-group">
                  <button class="action-btn" id="translate-btn">Translate to CNL</button>
                  <button class="action-btn secondary" id="clear-nl-btn">Clear</button>
                </div>
              </div>
            </div>
            
            <!-- CNL Output -->
            <div class="cnl-panel">
              <div class="panel-header">
                <span>Generated CNL</span>
                <span id="cnl-status"></span>
              </div>
              <div class="panel-content">
                <div class="cnl-output" id="cnl-output">
                  <div class="empty-state">Translated CNL will appear here...</div>
                </div>
              </div>
              <div class="panel-header" style="border-top: 1px solid var(--border); border-bottom: none;">
                <div class="button-group">
                  <button class="action-btn" id="validate-cnl-btn" disabled>Validate CNL</button>
                  <button class="action-btn secondary" id="edit-cnl-btn" disabled>Edit</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="cnl-row" style="border-top: 1px solid var(--border);">
            <!-- Spec Builder -->
            <div class="cnl-panel">
              <div class="panel-header">
                <span>Spec Builder</span>
              </div>
              <div class="panel-content">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; height: 100%;">
                  <div>
                    <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Title</label>
                    <input type="text" id="spec-title" placeholder="Story title..." 
                           style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border); 
                                  color: var(--text-primary); padding: 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                  </div>
                  <div>
                    <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Synopsis</label>
                    <textarea id="spec-synopsis" placeholder="Brief story synopsis..." 
                              style="height: 80px; resize: none;"></textarea>
                  </div>
                  <div>
                    <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Themes (comma-separated)</label>
                    <input type="text" id="spec-themes" placeholder="courage, family, redemption..." 
                           style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border); 
                                  color: var(--text-primary); padding: 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                  </div>
                  <div>
                    <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">World Rules (one per line)</label>
                    <textarea id="spec-world-rules" placeholder="No magic&#10;Modern setting&#10;Coastal village location" 
                              style="height: 60px; resize: none;"></textarea>
                  </div>
                </div>
              </div>
              <div class="panel-header" style="border-top: 1px solid var(--border); border-bottom: none;">
                <button class="action-btn" id="create-spec-btn">Create Specification</button>
              </div>
            </div>
            
            <!-- Spec Preview / Details -->
            <div class="cnl-panel">
              <div class="panel-header">
                <span>Spec Preview</span>
                <span id="spec-preview-status"></span>
              </div>
              <div class="panel-content">
                <div class="json-view" id="spec-preview">
                  <div class="empty-state">Select or create a spec to preview it here...</div>
                </div>
              </div>
              <div class="panel-header" style="border-top: 1px solid var(--border); border-bottom: none;">
                <div class="button-group">
                  <button class="action-btn" id="generate-plan-btn" disabled>Generate Plan</button>
                  <button class="action-btn secondary" id="delete-spec-btn" disabled>Delete</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <aside class="logs-panel">
      <div class="logs-header">
        <h2>Live Logs</h2>
        <div class="logs-controls">
          <select id="log-level-filter">
            <option value="">All Levels</option>
            <option value="DEBUG">DEBUG</option>
            <option value="INFO" selected>INFO+</option>
            <option value="WARN">WARN+</option>
            <option value="ERROR">ERROR+</option>
          </select>
          <button id="clear-logs">Clear</button>
        </div>
      </div>
      <div class="logs-list" id="logs-list"></div>
    </aside>
  </div>
  
  <script>
    // Example definitions for API Explorer
    const EXAMPLES = {
      'cnl-validate': {
        method: 'POST',
        endpoint: '/v1/cnl/validate',
        body: {
          cnl_text: 'CHARACTER(Anna).\nTRAIT(Anna, courageous).\nGOAL(Anna, protect, "brother").\nRULE(Scene_3, must_include, "storm").'
        }
      },
      'cnl-translate': {
        method: 'POST',
        endpoint: '/v1/cnl/translate',
        body: {
          nl_text: 'Anna must stay courageous, and a storm must appear in scene 3. The story should have a hopeful ending.',
          context: {}
        }
      },
      'vsa-encode': {
        method: 'POST',
        endpoint: '/v1/vsa/encode',
        body: {
          text: 'A storm gathers at sea, dark clouds rolling in from the horizon.',
          dim: 1000,
          seed: 42
        }
      },
      'vsa-similarity': {
        method: 'POST',
        endpoint: '/v1/vsa/encode',
        body: {
          text: 'storm at sea',
          dim: 100,
          seed: 42,
          _note: 'To compare, encode two texts and use cosine similarity on vectors'
        }
      },
      'create-spec': {
        method: 'POST',
        endpoint: '/v1/specs',
        body: {
          spec: {
            title: 'The Storm Within',
            synopsis: 'A story about courage in the face of adversity.',
            themes: ['courage', 'family', 'redemption'],
            cnl_constraints: 'CHARACTER(Anna).\nTRAIT(Anna, courageous).\nGOAL(Anna, protect, "brother").\nRULE(Story, tone, hopeful).',
            characters: [
              { name: 'Anna', traits: ['courageous', 'determined'], goals: [{ action: 'protect', target: 'brother' }] },
              { name: 'Marcus', traits: ['vulnerable', 'hopeful'], goals: [] }
            ],
            world_rules: ['No magic', 'Modern setting']
          }
        }
      },
      'create-plan': {
        method: 'POST',
        endpoint: '/v1/plans',
        body: {
          spec_id: '{{SPEC_ID}}',
          planning_params: {
            structure: 'three_act',
            scene_count: 9
          }
        },
        requires: ['create-spec']
      },
      'generate': {
        method: 'POST',
        endpoint: '/v1/generate',
        body: {
          plan_id: '{{PLAN_ID}}',
          scene_id: 'scene_1'
        },
        requires: ['create-plan']
      },
      'full-pipeline': {
        method: 'POST',
        endpoint: '/v1/pipelines/run',
        body: {
          use_default: true,
          spec_id: '{{SPEC_ID}}'
        },
        requires: ['create-spec']
      },
      'verify': {
        method: 'POST',
        endpoint: '/v1/verify',
        body: {
          spec_id: '{{SPEC_ID}}',
          artifact_ref: { id: '{{DRAFT_ID}}', type: 'draft' }
        },
        requires: ['generate']
      },
      'guardrail': {
        method: 'POST',
        endpoint: '/v1/guardrail/check',
        body: {
          artifact_ref: { id: '{{DRAFT_ID}}', type: 'draft' },
          policies: ['bias', 'originality', 'pii', 'harmful'],
          text: 'It was a dark and stormy night. Anna knew she had to save her brother from the angry black man who threatened him.'
        }
      },
      'evaluate': {
        method: 'POST',
        endpoint: '/v1/evaluate',
        body: {
          artifact_ref: { id: '{{DRAFT_ID}}', type: 'draft' },
          metrics: ['nqs', 'coherence', 'readability', 'cad'],
          text: 'Anna was brave. She faced the storm with courage. The wind howled but she pressed on. Her brother needed her help. Through the darkness she found her way.'
        }
      },
      'review': {
        method: 'POST',
        endpoint: '/v1/review',
        body: {
          artifact_ref: { id: 'draft_test', type: 'draft' },
          criteria: ['pacing', 'dialogue', 'description', 'originality'],
          text: '"Hello," said Anna. "How are you?"\n"I\'m fine," said John. "The weather is nice."\n\nThe sun was bright and warm. Birds were singing in the trees. Anna walked slowly through the garden, feeling peaceful and content.'
        }
      },
      'research': {
        method: 'POST',
        endpoint: '/v1/research/query',
        body: {
          query: 'How does narrative coherence work in storytelling?',
          top_k: 5
        }
      },
      'explain': {
        method: 'POST',
        endpoint: '/v1/explain',
        body: {
          artifact_ref: { id: 'draft_test', type: 'draft' },
          question: 'Why did the guardrail check fail?'
        }
      },
      'reverse': {
        method: 'POST',
        endpoint: '/v1/reverse-engineer',
        body: {
          output: 'spec',
          text: 'Anna was a brave warrior who lived in a small village. Her brother Marcus needed protection from raiders. "I will save you," she promised. The journey was dangerous but Anna was determined to succeed.'
        }
      },
      'compliance': {
        method: 'POST',
        endpoint: '/v1/reports/compliance',
        body: {
          artifact_ref: { id: 'draft_test', type: 'draft' },
          policies: ['bias', 'pii', 'harmful'],
          text: 'A normal story about ordinary people doing ordinary things in an ordinary town.'
        }
      },
      'audit-logs': {
        method: 'GET',
        endpoint: '/v1/audit/logs',
        body: null
      },
      'audit-verify': {
        method: 'GET',
        endpoint: '/v1/audit/verify',
        body: null
      }
    };
    
    // State
    let currentSpecId = null;
    let currentPlanId = null;
    let currentDraftId = null;
    let currentCnl = '';
    let selectedSpec = null;
    let eventSource = null;
    let logs = [];
    const logLevelPriority = { DEBUG: 0, INFO: 1, WARN: 2, ERROR: 3, FATAL: 4 };
    
    // DOM Elements - API Explorer
    const methodSelect = document.getElementById('method-select');
    const endpointInput = document.getElementById('endpoint-input');
    const requestBody = document.getElementById('request-body');
    const responseBody = document.getElementById('response-body');
    const responseStatus = document.getElementById('response-status');
    const runBtn = document.getElementById('run-btn');
    const runText = document.getElementById('run-text');
    
    // DOM Elements - CNL Studio
    const nlInput = document.getElementById('nl-input');
    const cnlOutput = document.getElementById('cnl-output');
    const cnlStatus = document.getElementById('cnl-status');
    const translateBtn = document.getElementById('translate-btn');
    const validateCnlBtn = document.getElementById('validate-cnl-btn');
    const editCnlBtn = document.getElementById('edit-cnl-btn');
    const clearNlBtn = document.getElementById('clear-nl-btn');
    const specTitle = document.getElementById('spec-title');
    const specSynopsis = document.getElementById('spec-synopsis');
    const specThemes = document.getElementById('spec-themes');
    const specWorldRules = document.getElementById('spec-world-rules');
    const createSpecBtn = document.getElementById('create-spec-btn');
    const specPreview = document.getElementById('spec-preview');
    const specsList = document.getElementById('specs-list');
    const refreshSpecsBtn = document.getElementById('refresh-specs');
    const generatePlanBtn = document.getElementById('generate-plan-btn');
    const deleteSpecBtn = document.getElementById('delete-spec-btn');
    
    // DOM Elements - Logs
    const logsList = document.getElementById('logs-list');
    const logLevelFilter = document.getElementById('log-level-filter');
    const clearLogsBtn = document.getElementById('clear-logs');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    
    // JSON Syntax Highlighting
    function syntaxHighlight(json) {
      if (typeof json !== 'string') {
        json = JSON.stringify(json, null, 2);
      }
      
      // Escape HTML
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      // Apply syntax highlighting
      return json.replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?|[{}\[\],:])/g,
        (match) => {
          let cls = 'json-number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'json-key';
              match = match.slice(0, -1) + '<span class="json-punctuation">:</span>';
            } else {
              cls = 'json-string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
          } else if (/null/.test(match)) {
            cls = 'json-null';
          } else if (/[{}\[\]]/.test(match)) {
            cls = 'json-bracket';
          } else if (/[:,]/.test(match)) {
            cls = 'json-punctuation';
          }
          return `<span class="${cls}">${match}</span>`;
        }
      );
    }
    
    // CNL Syntax Highlighting
    function highlightCnl(cnlText) {
      if (!cnlText) return '';
      
      return cnlText.split('\n').map(line => {
        const trimmed = line.trim();
        if (!trimmed) return '';
        
        // Match predicate and arguments
        const match = trimmed.match(/^(\w+)\((.*)\)\.?$/);
        if (match) {
          const predicate = match[1];
          const args = match[2];
          return `<span class="cnl-statement"><span class="cnl-predicate">${predicate}</span>(<span class="cnl-args">${escapeHtml(args)}</span>).</span>`;
        }
        
        // Comment or other
        if (trimmed.startsWith('//') || trimmed.startsWith('#')) {
          return `<span style="color: var(--text-secondary)">${escapeHtml(trimmed)}</span>`;
        }
        
        return escapeHtml(trimmed);
      }).join('\n');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // View switching
    document.querySelectorAll('.header-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const view = tab.dataset.view;
        
        // Update tab states
        document.querySelectorAll('.header-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update view visibility
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${view}-view`).classList.add('active');
        
        // Update sidebar visibility
        document.getElementById('api-sidebar').style.display = view === 'api' ? '' : 'none';
        document.getElementById('cnl-sidebar').style.display = view === 'cnl' ? '' : 'none';
        
        // Load specs when switching to CNL view
        if (view === 'cnl') {
          loadSpecs();
        }
      });
    });
    
    // Initialize SSE for logs
    function initLogStream() {
      if (eventSource) {
        eventSource.close();
      }
      
      eventSource = new EventSource('/api/logs/stream');
      
      eventSource.addEventListener('init', (e) => {
        logs = JSON.parse(e.data);
        renderLogs();
      });
      
      eventSource.addEventListener('log', (e) => {
        const log = JSON.parse(e.data);
        logs.push(log);
        if (logs.length > 500) logs.shift();
        renderLogs();
      });
      
      eventSource.onopen = () => {
        statusDot.style.background = 'var(--success)';
        statusText.textContent = 'Connected';
      };
      
      eventSource.onerror = () => {
        statusDot.style.background = 'var(--error)';
        statusText.textContent = 'Disconnected';
        setTimeout(initLogStream, 3000);
      };
    }
    
    // Render logs
    function renderLogs() {
      const filterLevel = logLevelFilter.value;
      const minPriority = filterLevel ? logLevelPriority[filterLevel] : -1;
      
      const filteredLogs = logs.filter(log => 
        logLevelPriority[log.level] >= minPriority
      );
      
      logsList.innerHTML = filteredLogs.slice(-100).map(log => {
        const time = new Date(log.timestamp).toLocaleTimeString();
        const context = Object.entries(log)
          .filter(([k]) => !['timestamp', 'level', 'message', 'service'].includes(k))
          .map(([k, v]) => `${k}=${typeof v === 'object' ? JSON.stringify(v) : v}`)
          .join(' ');
        
        return `
          <div class="log-entry ${log.level}">
            <span class="log-time">${time}</span>
            <span class="log-level ${log.level}">${log.level}</span>
            <span class="log-message">${escapeHtml(log.message)}</span>
            ${context ? `<div class="log-context">${escapeHtml(context)}</div>` : ''}
          </div>
        `;
      }).join('');
      
      logsList.scrollTop = logsList.scrollHeight;
    }
    
    // Load example (API Explorer)
    function loadExample(name) {
      const example = EXAMPLES[name];
      if (!example) return;
      
      methodSelect.value = example.method;
      endpointInput.value = example.endpoint;
      
      // Replace placeholders with actual IDs
      let bodyStr = example.body ? JSON.stringify(example.body, null, 2) : '';
      if (currentSpecId) bodyStr = bodyStr.replace(/\{\{SPEC_ID\}\}/g, currentSpecId);
      if (currentPlanId) bodyStr = bodyStr.replace(/\{\{PLAN_ID\}\}/g, currentPlanId);
      if (currentDraftId) bodyStr = bodyStr.replace(/\{\{DRAFT_ID\}\}/g, currentDraftId);
      
      requestBody.value = bodyStr;
      
      // Update active state
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.example === name);
      });
    }
    
    // Run API request
    async function runRequest() {
      const method = methodSelect.value;
      const endpoint = endpointInput.value;
      
      runBtn.disabled = true;
      runText.innerHTML = '<span class="spinner"></span>Running...';
      responseStatus.innerHTML = '';
      responseBody.innerHTML = '<span style="color: var(--text-secondary)">Loading...</span>';
      
      try {
        const options = {
          method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (method !== 'GET' && method !== 'HEAD' && requestBody.value.trim()) {
          options.body = requestBody.value;
        }
        
        const startTime = performance.now();
        const response = await fetch(endpoint, options);
        const duration = Math.round(performance.now() - startTime);
        
        const data = await response.json();
        
        // Update status
        const statusClass = response.ok ? 'success' : 'error';
        responseStatus.innerHTML = `
          <span class="status-badge ${statusClass}">${response.status}</span>
          <span style="color: var(--text-secondary); font-size: 0.75rem;">${duration}ms</span>
        `;
        
        // Format and display response with syntax highlighting
        responseBody.innerHTML = syntaxHighlight(data);
        
        // Store IDs for chaining
        if (data.spec?.id) currentSpecId = data.spec.id;
        if (data.plan?.id) currentPlanId = data.plan.id;
        if (data.job_id) {
          // Fetch job to get draft ID
          const jobRes = await fetch(`/v1/generate/${data.job_id}`);
          const jobData = await jobRes.json();
          if (jobData.output_refs?.[0]?.id) {
            currentDraftId = jobData.output_refs[0].id;
          }
        }
        if (data.run_id && data.context?.draft_id) {
          currentDraftId = data.context.draft_id;
        }
        
      } catch (err) {
        responseStatus.innerHTML = '<span class="status-badge error">Error</span>';
        responseBody.innerHTML = `<span style="color: var(--error)">Error: ${escapeHtml(err.message)}</span>`;
      } finally {
        runBtn.disabled = false;
        runText.textContent = 'Run Request';
      }
    }
    
    // CNL Studio: Translate NL to CNL
    async function translateToCnl() {
      const text = nlInput.value.trim();
      if (!text) return;
      
      translateBtn.disabled = true;
      translateBtn.innerHTML = '<span class="spinner"></span>Translating...';
      cnlStatus.innerHTML = '';
      cnlOutput.innerHTML = '<span style="color: var(--text-secondary)">Translating...</span>';
      
      try {
        const response = await fetch('/v1/cnl/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nl_text: text, context: {} })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }
        
        currentCnl = data.cnl_text || '';
        cnlOutput.innerHTML = highlightCnl(currentCnl);
        cnlStatus.innerHTML = `<span class="status-badge success">${data.statement_count || 0} statements</span>`;
        
        validateCnlBtn.disabled = false;
        editCnlBtn.disabled = false;
        
        // Auto-extract title and themes if possible
        if (data.extracted) {
          if (data.extracted.title) specTitle.value = data.extracted.title;
          if (data.extracted.themes) specThemes.value = data.extracted.themes.join(', ');
        }
        
      } catch (err) {
        cnlOutput.innerHTML = `<span style="color: var(--error)">Error: ${escapeHtml(err.message)}</span>`;
        cnlStatus.innerHTML = '<span class="status-badge error">Failed</span>';
      } finally {
        translateBtn.disabled = false;
        translateBtn.textContent = 'Translate to CNL';
      }
    }
    
    // CNL Studio: Validate CNL
    async function validateCnl() {
      if (!currentCnl) return;
      
      validateCnlBtn.disabled = true;
      validateCnlBtn.innerHTML = '<span class="spinner"></span>Validating...';
      
      try {
        const response = await fetch('/v1/cnl/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cnl_text: currentCnl })
        });
        
        const data = await response.json();
        
        if (data.valid) {
          cnlStatus.innerHTML = `<span class="status-badge success">Valid (${data.statements?.length || 0} statements)</span>`;
        } else {
          cnlStatus.innerHTML = `<span class="status-badge error">${data.errors?.length || 0} errors</span>`;
          // Show errors in output
          const errorHtml = data.errors?.map(e => 
            `<span class="cnl-invalid">// Error: ${escapeHtml(e.message || e)}</span>`
          ).join('\n');
          cnlOutput.innerHTML = highlightCnl(currentCnl) + '\n\n' + errorHtml;
        }
        
      } catch (err) {
        cnlStatus.innerHTML = '<span class="status-badge error">Validation failed</span>';
      } finally {
        validateCnlBtn.disabled = false;
        validateCnlBtn.textContent = 'Validate CNL';
      }
    }
    
    // CNL Studio: Create Specification
    async function createSpec() {
      const title = specTitle.value.trim();
      const synopsis = specSynopsis.value.trim();
      const themes = specThemes.value.split(',').map(t => t.trim()).filter(Boolean);
      const worldRules = specWorldRules.value.split('\n').map(r => r.trim()).filter(Boolean);
      
      if (!title) {
        alert('Please enter a title for the specification');
        return;
      }
      
      createSpecBtn.disabled = true;
      createSpecBtn.innerHTML = '<span class="spinner"></span>Creating...';
      
      try {
        const spec = {
          title,
          synopsis: synopsis || `A story titled "${title}"`,
          themes,
          cnl_constraints: currentCnl || '',
          characters: [],
          world_rules: worldRules
        };
        
        // Try to extract characters from CNL
        if (currentCnl) {
          const charMatches = currentCnl.matchAll(/CHARACTER\((\w+)\)/g);
          const traitMatches = [...currentCnl.matchAll(/TRAIT\((\w+),\s*(\w+)\)/g)];
          const goalMatches = [...currentCnl.matchAll(/GOAL\((\w+),\s*(\w+),\s*"?([^"]+)"?\)/g)];
          
          const charSet = new Set();
          for (const match of charMatches) {
            charSet.add(match[1]);
          }
          
          spec.characters = [...charSet].map(name => ({
            name,
            traits: traitMatches.filter(m => m[1] === name).map(m => m[2]),
            goals: goalMatches.filter(m => m[1] === name).map(m => ({ action: m[2], target: m[3] }))
          }));
        }
        
        const response = await fetch('/v1/specs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ spec })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }
        
        currentSpecId = data.spec.id;
        selectedSpec = data.spec;
        
        // Show in preview
        specPreview.innerHTML = syntaxHighlight(data.spec);
        document.getElementById('spec-preview-status').innerHTML = '<span class="status-badge success">Created</span>';
        
        generatePlanBtn.disabled = false;
        deleteSpecBtn.disabled = false;
        
        // Refresh specs list
        loadSpecs();
        
        // Clear form
        specTitle.value = '';
        specSynopsis.value = '';
        specThemes.value = '';
        specWorldRules.value = '';
        
      } catch (err) {
        alert('Error creating spec: ' + err.message);
      } finally {
        createSpecBtn.disabled = false;
        createSpecBtn.textContent = 'Create Specification';
      }
    }
    
    // CNL Studio: Load Specs List
    async function loadSpecs() {
      try {
        const response = await fetch('/v1/specs');
        const data = await response.json();
        
        if (!data.specs || data.specs.length === 0) {
          specsList.innerHTML = '<div class="empty-state">No specs yet. Create one!</div>';
          return;
        }
        
        specsList.innerHTML = data.specs.map(spec => `
          <div class="spec-card ${selectedSpec?.id === spec.id ? 'selected' : ''}" data-id="${spec.id}">
            <div class="spec-title">${escapeHtml(spec.title || 'Untitled')}</div>
            <div class="spec-meta">${spec.id}</div>
            ${spec.themes?.length ? `
              <div class="spec-themes">
                ${spec.themes.slice(0, 3).map(t => `<span class="spec-theme">${escapeHtml(t)}</span>`).join('')}
                ${spec.themes.length > 3 ? `<span class="spec-theme">+${spec.themes.length - 3}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `).join('');
        
        // Add click handlers
        specsList.querySelectorAll('.spec-card').forEach(card => {
          card.addEventListener('click', () => selectSpec(card.dataset.id, data.specs.find(s => s.id === card.dataset.id)));
        });
        
      } catch (err) {
        specsList.innerHTML = `<div class="empty-state" style="color: var(--error)">Error loading specs</div>`;
      }
    }
    
    // CNL Studio: Select a Spec
    function selectSpec(id, spec) {
      selectedSpec = spec;
      currentSpecId = id;
      
      // Update UI
      specsList.querySelectorAll('.spec-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === id);
      });
      
      // Show in preview
      specPreview.innerHTML = syntaxHighlight(spec);
      document.getElementById('spec-preview-status').innerHTML = '';
      
      generatePlanBtn.disabled = false;
      deleteSpecBtn.disabled = false;
      
      // Load CNL into output
      if (spec.cnl_constraints) {
        currentCnl = spec.cnl_constraints;
        cnlOutput.innerHTML = highlightCnl(currentCnl);
        validateCnlBtn.disabled = false;
        editCnlBtn.disabled = false;
      }
    }
    
    // CNL Studio: Generate Plan
    async function generatePlan() {
      if (!currentSpecId) return;
      
      generatePlanBtn.disabled = true;
      generatePlanBtn.innerHTML = '<span class="spinner"></span>Generating...';
      
      try {
        const response = await fetch('/v1/plans', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            spec_id: currentSpecId,
            planning_params: {
              structure: 'three_act',
              scene_count: 9
            }
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }
        
        currentPlanId = data.plan.id;
        specPreview.innerHTML = syntaxHighlight(data.plan);
        document.getElementById('spec-preview-status').innerHTML = '<span class="status-badge success">Plan Generated</span>';
        
      } catch (err) {
        alert('Error generating plan: ' + err.message);
      } finally {
        generatePlanBtn.disabled = false;
        generatePlanBtn.textContent = 'Generate Plan';
      }
    }
    
    // CNL Studio: Delete Spec
    async function deleteSpec() {
      if (!currentSpecId || !confirm('Delete this specification?')) return;
      
      try {
        const response = await fetch(`/v1/specs/${currentSpecId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          selectedSpec = null;
          currentSpecId = null;
          specPreview.innerHTML = '<div class="empty-state">Select or create a spec to preview it here...</div>';
          generatePlanBtn.disabled = true;
          deleteSpecBtn.disabled = true;
          loadSpecs();
        }
      } catch (err) {
        alert('Error deleting spec: ' + err.message);
      }
    }
    
    // Event listeners - API Explorer
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', () => loadExample(btn.dataset.example));
    });
    
    runBtn.addEventListener('click', runRequest);
    
    // Event listeners - CNL Studio
    translateBtn.addEventListener('click', translateToCnl);
    validateCnlBtn.addEventListener('click', validateCnl);
    clearNlBtn.addEventListener('click', () => {
      nlInput.value = '';
      cnlOutput.innerHTML = '<div class="empty-state">Translated CNL will appear here...</div>';
      currentCnl = '';
      cnlStatus.innerHTML = '';
      validateCnlBtn.disabled = true;
      editCnlBtn.disabled = true;
    });
    createSpecBtn.addEventListener('click', createSpec);
    refreshSpecsBtn.addEventListener('click', loadSpecs);
    generatePlanBtn.addEventListener('click', generatePlan);
    deleteSpecBtn.addEventListener('click', deleteSpec);
    
    editCnlBtn.addEventListener('click', () => {
      const newCnl = prompt('Edit CNL:', currentCnl);
      if (newCnl !== null) {
        currentCnl = newCnl;
        cnlOutput.innerHTML = highlightCnl(currentCnl);
        cnlStatus.innerHTML = '<span class="status-badge warning">Edited</span>';
      }
    });
    
    // Event listeners - Logs
    logLevelFilter.addEventListener('change', renderLogs);
    
    clearLogsBtn.addEventListener('click', () => {
      logs = [];
      renderLogs();
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const activeView = document.querySelector('.header-tab.active').dataset.view;
        if (activeView === 'api') {
          runRequest();
        } else {
          translateToCnl();
        }
      }
    });
    
    // Initialize
    initLogStream();
    loadExample('cnl-validate');
  </script>
</body>
</html>
